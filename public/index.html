<!DOCTYPE html>
<html lang="en" class="dark">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>JWLimited CDN • Professional Asset Delivery</title>
		<link rel="icon" href="/assets/applications/icons/jwlimited_developer.png" />
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<link rel="stylesheet" href="__root/style/base.css">
	<body>
		<div class="loading-wrapper">
			<main class="main-wrapper" id="app">
				<div class="main-content">
					<canvas id="canvas" style="filter: blur(100px) saturate(1.5) brightness(0.2) hue-rotate(297deg); z-index: -1"></canvas>
					<script>
						//************** Shader sources **************
						var vertexSource = `
					attribute vec2 position;
					void main() {
					gl_Position = vec4(position, 0, 1.0);
					}
					`;

						var fragmentSource = `
					#define PI 3.14159265358979323846
					precision highp float;

					uniform float width;
					uniform float height;
					vec2 resolution = vec2(width, height);
					uniform float time;

					//from bookofshaders.com
					float random (in vec2 st) {
						return fract(sin(dot(st.xy/PI, vec2(12.9898,78.233))) * 43758.5453123);
					}

					vec2 rotate(vec2 _st, float _angle) {
						_st -= 0.5;
						_st =  mat2(cos(_angle),-sin(_angle), sin(_angle),cos(_angle)) * _st;
						_st.y += 0.5;
							_st.x += .5;
						return _st;
					}

					// https://www.shadertoy.com/view/4dS3Wd Morgan McGuire
					float noise (in vec2 st) {
						vec2 i = floor(st);
						vec2 f = fract(st);

						// Four corners in 2D of a tile
						float a = random(i);
						float b = random(i + vec2(1.0, 0.0));
						float c = random(i + vec2(0.0, 1.0));
						float d = random(i + vec2(1.0, 1.0));

						// Cubic Hermine Curve.  Same as SmoothStep()
						vec2 u = f*f*(3.0-2.0*f);
						// u = smoothstep(0.,1.,f);

						// Mix 4 corners as percentages
						return mix(a, b, u.x) +
								(c - a)* u.y * (1.0 - u.x) +
								(d - b) * u.x * u.y;
					}


					float surface(vec2 pos, float radius, float time) {
						float sphere = length(pos)*3.0;//(distance from center)
						float a = atan(pos.y,pos.x);
						float m = a*time;
						m += noise(pos+time*0.1)*.5;
						a *= 1.+abs(atan(time*0.2))*.1;
						a *= 1.+noise(pos+time*0.1)*0.1;
						float distortion = .002*(1.0-pos.y);
						radius += sin(a*50.)*noise(pos+time*.2)*distortion;
						radius += (sin(a*20.)*.002);
						return 1.-smoothstep(radius,radius+0.015,sphere);
					}

					void main(){

						//translation
					float aspect = width/height;
					vec2 uv = gl_FragCoord.xy/resolution.xy;
					float mini = min(width, height);
					float maxi = max(width, height);
					float factor = width > height ? mini : maxi;
					uv.x = (uv.x * aspect)-(.5*(width-height)/factor);

					//time and distance
					float period = 17.2*PI;
						float t = mod(time, period);
					vec2 pos = uv;//position of sun
					pos = vec2(0.5, 1.0-10.0*sin(t*.003))-pos;
					float ds = length(pos);//distance from sun
					float dc = distance(vec2(.5,.5), uv);//distance from center
						float ids = 1.0 - ds;//inverse distance from sun

					//star field
					float movement = .00;//none
					float rotation = -t*.0000;//none
					float twinkle = (1.0+.2*cos(t*40.0*random(uv)));

					//set up first layer of stars:
					//most distant tiny stars
					vec2 starPos = uv;
					starPos.y -= t*movement;
					starPos = rotate(starPos, rotation);
					float r = random(floor(starPos*500.));
					float brightnessModifier = .3*(fract(r*9.445)+.1);
					r *= step(.97, r);//limit to 3% selection of cells
					vec3 stars = vec3(.5,.7,1.0) * vec3(r)*ds;//a color that's dimmer close to sun
					stars *= 1.0-step(ds,.2);//mask starfield at sun, not really necessary due to previous step.
					vec4 starfield = brightnessModifier*vec4(stars,1.0);

					//and then same thing for three more layers of stars:

					//medium distance white stars
					vec2 starPos2 = uv;
					starPos2.y -= t*movement;
					starPos2 = rotate(starPos2, rotation);
					float r2 = random(floor(starPos2*450.));
					brightnessModifier = fract(r2*14.4548);
					r2 *= step(.99, r2);
					vec3 stars2 = vec3(.5,.5,1.0) * vec3(r2)*ds;
					stars2 *= 1.0-step(ds,.2);
					vec4 starfield2 = (twinkle)*(.77*brightnessModifier)*vec4(stars2,1.0);

					//dimmer, red stars
					vec2 starPos3 = uv;
					starPos3.y -= t*movement;
					starPos3 = rotate(starPos3, rotation);
					float r3 = random(floor(starPos3*470.));
					brightnessModifier = .4*fract(r3*68.7);
					r3 *= step(.9975, r3);
					vec3 stars3 = vec3(1.0,.7,.7) * vec3(r3)*ds;
					stars3 *= 1.0-step(ds,.2);
					vec4 starfield3 = twinkle*(brightnessModifier)*vec4(stars3,1.0);

					//closer/brighter and bluer stars
					vec2 starPos4 = uv;
					starPos4.y -= t*movement;
					starPos4 = rotate(starPos4, rotation);
					float r4 = random(floor(starPos4*400.));
					brightnessModifier = .5+.5*fract(r4*34.5234);
					r4 *= step(.9986, r4);
					vec3 stars4 = vec3(.5,.5,1.0) * vec3(r4)*ds;
					stars4 += vec3(0.0,0.0,.05);//adding tiny bit of overall blue to space here
					stars4 *= 1.0-step(ds,.2);
					vec4 starfield4 = twinkle*brightnessModifier*vec4(stars4,1.0);

					float starfieldBrightness = .8;

					//sun
					vec3 red = -ds + vec3(1.0,0.0,0.1);
					vec3 grn = vec3(0.0,.1/uv.y,0.0);//not used
					vec3 orange = -ds+ vec3(1.0,.4,0.5+dc);
					vec3 yellow = vec3(.9,1.0,.3+.75*ds)*clamp(ids, 0.0, 1.0);
					vec3 lime = vec3(1.0,1.0,.1)*clamp(ids, 0.0, 1.0);
					float surfaceTemp = 1.0;
					float lensing = (1.0-uv.y)-.5;//bigger sun as y goes down to 0
					vec3 colorz = (yellow)*(lime)*(lensing+.9*(lime+yellow+orange+red));
					float sunsetFactor = 2.0*uv.y;//less white color as sun goes down

					gl_FragColor = starfieldBrightness*(starfield2+starfield+starfield3+starfield4)+vec4(colorz+(sunsetFactor*(surfaceTemp*surface(pos,.6+.5*lensing,t))),1.0);

					}
					`;

						//************** Utility functions **************

						function onWindowResize() {
							canvas.width = window.innerWidth; //Math.min(window.innerWidth, window.innerHeight);
							canvas.height = window.innerHeight;
							gl.viewport(0, 0, canvas.width, canvas.height);
							gl.uniform1f(widthHandle, canvas.width);
							gl.uniform1f(heightHandle, canvas.height);
						}

						//Compile shader and combine with source
						function compileShader(shaderSource, shaderType) {
							var shader = gl.createShader(shaderType);
							gl.shaderSource(shader, shaderSource);
							gl.compileShader(shader);
							if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
								throw 'Shader compile failed with: ' + gl.getShaderInfoLog(shader);
							}
							return shader;
						}

						function getAttribLocation(program, name) {
							var attributeLocation = gl.getAttribLocation(program, name);
							if (attributeLocation === -1) {
								throw 'Cannot find attribute ' + name + '.';
							}
							return attributeLocation;
						}

						function getUniformLocation(program, name) {
							var attributeLocation = gl.getUniformLocation(program, name);
							if (attributeLocation === -1) {
								throw 'Cannot find uniform ' + name + '.';
							}
							return attributeLocation;
						}

						//=============== Create shaders ==============

						var canvas = document.getElementById('canvas');
						var gl = canvas.getContext('webgl');
						window.onload = onWindowResize;
						window.addEventListener('resize', onWindowResize, false);

						//Create vertex and fragment shaders
						var vertexShader = compileShader(vertexSource, gl.VERTEX_SHADER);
						var fragmentShader = compileShader(fragmentSource, gl.FRAGMENT_SHADER);

						//Create shader programs
						var program = gl.createProgram();
						gl.attachShader(program, vertexShader);
						gl.attachShader(program, fragmentShader);
						gl.linkProgram(program);
						gl.useProgram(program);

						//Set up rectangle covering entire canvas
						var vertexData = new Float32Array([
							-1.0,
							1.0, // top left
							-1.0,
							-1.0, // bottom left
							1.0,
							1.0, // top right
							1.0,
							-1.0, // bottom right
						]);

						//Create vertex buffer
						var vertexDataBuffer = gl.createBuffer();
						gl.bindBuffer(gl.ARRAY_BUFFER, vertexDataBuffer);
						gl.bufferData(gl.ARRAY_BUFFER, vertexData, gl.STATIC_DRAW);

						// Layout of our data in the vertex buffer
						var positionHandle = getAttribLocation(program, 'position');

						gl.enableVertexAttribArray(positionHandle);
						gl.vertexAttribPointer(
							positionHandle,
							2, // position is a vec2 (2 values per component)
							gl.FLOAT, // each component is a float
							false, // don't normalize values
							2 * 4, // two 4 byte float components per vertex (32 bit float is 4 bytes) (stride)
							0 // how many bytes inside the buffer to start from (offset)
						);

						//Set uniform handle
						var timeHandle = getUniformLocation(program, 'time');
						var widthHandle = getUniformLocation(program, 'width');
						var heightHandle = getUniformLocation(program, 'height');

						//================= initialize! ============================
						//Time
						var dt = 0.0;
						var time = 39.0;

						function draw() {
							time += dt;

							gl.uniform1f(timeHandle, time);
							//Draw a triangle strip connecting vertices 0-4
							gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

							requestAnimationFrame(draw);
						}

						draw();
					</script>
					<div class="background-grid"></div>
					<div class="gradient-orb orb-1"></div>
					<div class="gradient-orb orb-2"></div>
					<div class="top-nav">
						<div class="nav-left">

						</div>
						<div class="nav-right">
							<div class="auth-container" id="authContainer">
								<div class="auth-logged-out" id="authLoggedOut">
									<div class="auth-actions">
										<button class="auth-btn auth-btn-ghost" id="loginBtn">
											<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
												<polyline points="10,17 15,12 10,7"/>
												<line x1="15" y1="12" x2="3" y2="12"/>
											</svg>
											Sign in
										</button>
										<button class="auth-btn auth-btn-primary" id="registerBtn">
											Get started
										</button>
									</div>
								</div>
								<div class="auth-logged-in" id="authLoggedIn" style="display: none;">
									<div class="user-menu">
										<button class="user-trigger" id="userMenuTrigger">
											<div class="user-avatar">
												<span class="user-initials" id="userInitials">U</span>
											</div>
											<div class="user-info">
												<span class="username" id="username">Loading...</span>
												<span class="user-role" id="userRole">user</span>
											</div>
											<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<polyline points="6,9 12,15 18,9"/>
											</svg>
										</button>
										<div class="user-dropdown" id="userDropdown">
											<div class="dropdown-item" id="dashboardBtn">
												<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
													<line x1="9" y1="9" x2="15" y2="9"/>
													<line x1="9" y1="15" x2="15" y2="15"/>
												</svg>
												Dashboard
											</div>
											<div class="dropdown-item" id="fileViewerBtn">
												<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
												</svg>
												Files
											</div>
											<div class="dropdown-divider"></div>
											<div class="dropdown-item" id="logoutBtn">
												<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
													<polyline points="16,17 21,12 16,7"/>
													<line x1="21" y1="12" x2="9" y2="12"/>
												</svg>
												Sign out
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="container mx-auto" id="main-area">
						<div class="header">
							<h1 class="logo">JWLimited CDN</h1>
							<p class="tagline">Professional Asset Delivery Network</p>
						</div>

						<div class="search-container">
							<button class="upload-btn" id="uploadBtn" title="Upload Asset">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
								>
									<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
									<polyline points="17,8 12,3 7,8" />
									<line x1="12" y1="3" x2="12" y2="15" />
								</svg>
							</button>
							<div class="search-wrapper">
								<svg
									class="search-icon"
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
								>
									<circle cx="11" cy="11" r="8" />
									<path d="m21 21-4.35-4.35" />
								</svg>

								<div class="loading-spinner" id="loadingSpinner"></div>
								<input
									type="text"
									class="search-input"
									placeholder="Search assets, images, fonts, styles..."
									id="searchInput"
									autocomplete="off"
									spellcheck="false"
								/>
							</div>
						</div>

										<div class="results-container" id="resultsContainer">
					<div class="results-grid" id="resultsGrid"></div>
				</div>

				<!-- Professional Search Mode Interface -->
				<div class="search-mode-active" id="searchModeContainer" style="display: none;">
					<div class="search-mode-layout">
						<!-- Header with Logo -->
						<header class="search-mode-header">
							<div class="search-mode-logo">
								JWLimited CDN
							</div>
							<div class="search-mode-actions">
								<button class="search-mode-close" id="searchModeClose" title="Exit search">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<line x1="18" y1="6" x2="6" y2="18"/>
										<line x1="6" y1="6" x2="18" y2="18"/>
									</svg>
								</button>
							</div>
						</header>

						<!-- Main Results Area -->
						<main class="search-mode-main">
							<div class="search-mode-results">
								<!-- Search Stats and Filters -->
								<div class="search-mode-stats" id="searchModeStats" style="display: none;">
									<div class="search-mode-stats-text" id="searchModeStatsText">
										About 0 results (0.00 seconds)
									</div>
									<div class="search-mode-filters" id="searchModeFilters">
										<button class="search-mode-filter active" data-filter="all">All</button>
										<button class="search-mode-filter" data-filter="images">Images</button>
										<button class="search-mode-filter" data-filter="videos">Videos</button>
										<button class="search-mode-filter" data-filter="fonts">Fonts</button>
										<button class="search-mode-filter" data-filter="styles">Styles</button>
										<button class="search-mode-filter" data-filter="icons">Icons</button>
										<button class="search-mode-filter" data-filter="documents">Documents</button>
									</div>
								</div>

								<!-- Loading State -->
								<div class="search-mode-loading" id="searchModeLoading" style="display: none;">
									<div class="search-mode-spinner"></div>
								</div>

								<!-- Results Grid -->
								<div class="search-mode-grid" id="searchModeGrid"></div>

								<!-- Empty State -->
								<div class="search-mode-empty" id="searchModeEmpty" style="display: none;">
									<svg class="search-mode-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="11" cy="11" r="8"/>
										<path d="m21 21-4.35-4.35"/>
									</svg>
									<h3 class="search-mode-empty-title">No results found</h3>
									<p class="search-mode-empty-description">
										Try adjusting your search terms or browse our asset categories.
									</p>
								</div>
							</div>
						</main>

						<!-- Search Bar at Bottom -->
						<div class="search-mode-search">
							<div class="search-mode-search-container">
								<div class="search-mode-search-wrapper">
									<svg class="search-mode-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="11" cy="11" r="8"/>
										<path d="m21 21-4.35-4.35"/>
									</svg>
									<input 
										type="text" 
										class="search-mode-search-input" 
										id="searchModeInput"
										placeholder="Search assets, images, fonts, styles..."
										autocomplete="off"
										spellcheck="false"
									/>
									<div class="search-mode-search-actions">
										<button class="search-mode-clear" id="searchModeClear" title="Clear search">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<line x1="18" y1="6" x2="6" y2="18"/>
												<line x1="6" y1="6" x2="18" y2="18"/>
											</svg>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
					</div>

					<div class="footer" id="footer">
						<div class="footer-links">
							<a href="#" class="footer-link" id="statusLink">Status</a>
							<a href="#" class="footer-link" id="apiLink">API</a>
							<a href="#" class="footer-link" id="devToolsLink">DevTools</a>
						</div>
						<p>Powered by Cloudflare Workers • Global Edge Network</p>
					</div>
				</div>
			</main>

			<div class="modal-wrapper" id="modalWrapper">
				<div class="auth-modal needs-shadow needs-scrolling" modal-animate="true" id="authModal">
					<div class="modal-backdrop"></div>
					<div class="modal-background-content">
					</div>
					<div class="auth-modal-content">
						<div class="modal-handle"></div>
						<div class="auth-modal-wrapper">
							<div class="auth-modal-header">
								<button class="auth-close-btn" id="authCloseBtn">
									<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<line x1="18" y1="6" x2="6" y2="18"/>
										<line x1="6" y1="6" x2="18" y2="18"/>
									</svg>
								</button>
								<div class="auth-header-content">
									<h2 class="auth-modal-title" id="authModalTitle">Sign in</h2>
									<p class="auth-modal-subtitle" id="authModalSubtitle">Welcome back to JWLimited CDN</p>
								</div>
							</div>

							<div class="auth-modal-body">
								<form class="auth-form" id="authForm">
									<div class="auth-form-group" id="usernameGroup">
										<label class="auth-form-label" for="authUsername">Username</label>
										<input type="text" class="auth-form-input" id="authUsername" required placeholder="Enter your username">
									</div>
									<div class="auth-form-group" id="emailGroup" style="display: none;">
										<label class="auth-form-label" for="authEmail">Email</label>
										<input type="email" class="auth-form-input" id="authEmail" placeholder="Enter your email">
									</div>
									<div class="auth-form-group">
										<label class="auth-form-label" for="authPassword">Password</label>
										<input type="password" class="auth-form-input" id="authPassword" required placeholder="Enter your password">
									</div>
									<div class="auth-form-group" id="totpGroup" style="display: none;">
										<label class="auth-form-label" for="authTotp">2FA Code</label>
										<input type="text" class="auth-form-input" id="authTotp" placeholder="Enter 6-digit code" maxlength="6">
									</div>

									<div id="authMessage"></div>

									<div class="auth-form-actions">
										<button type="submit" class="auth-submit-btn" id="authSubmit">
											<span class="auth-btn-text">Sign in</span>
											<div class="auth-btn-loading" style="display: none;">
												<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M21 12a9 9 0 11-6.219-8.56"/>
												</svg>
											</div>
										</button>
									</div>
								</form>

								<div class="auth-form-switch">
									<span id="authSwitchText">Don't have an account?</span>
									<button type="button" class="auth-switch-btn" id="authSwitchBtn">Get started</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="dashboard-modal needs-shadow needs-scrolling" modal-animate="true" id="dashboardModal">
					<div class="modal-backdrop"></div>
					<div class="modal-background-content">
					</div>
					<div class="dashboard-modal-content">
						<div class="modal-handle"></div>
						<div class="dashboard-wrapper">
							<!-- Dashboard Header -->
							<div class="dashboard-header">
								<div class="dashboard-header-left">
									<div class="dashboard-title-section">
										<h1 class="dashboard-title">Dashboard</h1>
										<p class="dashboard-subtitle">Welcome back, <span id="dashboardUsername">User</span></p>
									</div>
								</div>
								<div class="dashboard-header-right">
									<button class="dashboard-close-btn" id="dashboardClose">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<line x1="18" y1="6" x2="6" y2="18"/>
											<line x1="6" y1="6" x2="18" y2="18"/>
										</svg>
									</button>
								</div>
							</div>

							<!-- Dashboard Content -->
							<div class="dashboard-content">
								<!-- Stats Grid -->
								<div class="dashboard-section">
									<div class="section-header">
										<h3 class="section-title">Overview</h3>
										<p class="section-subtitle">Your account usage and statistics</p>
									</div>
									<div class="dashboard-stats" id="dashboardStats">
										<!-- Stats will be loaded dynamically -->
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="dashboard-modal needs-shadow needs-scrolling" modal-animate="true" id="statusModal">
					<div class="modal-backdrop"></div>
					<div class="modal-background-content">
					</div>
					<div class="dashboard-modal-content">
						<div class="modal-handle"></div>
						<div class="dashboard-wrapper">
							<div class="dashboard-header">
								<div class="dashboard-header-left">
									<div class="dashboard-title-section">
										<h1 class="dashboard-title">System Status</h1>
										<p class="dashboard-subtitle">Real-time CDN performance and global network status</p>
									</div>
								</div>
								<div class="dashboard-header-right">
									<button class="dashboard-close-btn" id="statusClose">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<line x1="18" y1="6" x2="6" y2="18"/>
											<line x1="6" y1="6" x2="18" y2="18"/>
										</svg>
									</button>
								</div>
							</div>

							<!-- Status Content -->
							<div class="dashboard-content">
								<div class="status-grid">
									<!-- System Stats -->
									<div class="status-section">
										<div class="section-header">
											<h3 class="section-title">Performance Metrics</h3>
											<p class="section-subtitle">Current system performance indicators</p>
										</div>
										<div class="dashboard-stats" id="systemStats">
											<!-- System stats will be loaded dynamically -->
										</div>
									</div>

									<!-- Global Network Map -->
									<div class="status-section">
										<div class="section-header">
											<h3 class="section-title">Global Network</h3>
											<p class="section-subtitle">Cloudflare CDN edge locations worldwide</p>
										</div>
										<div class="network-map-container">
											<div class="network-map" id="networkMap">
												<!-- Network map will be loaded here -->
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="dashboard-modal needs-shadow needs-scrolling" modal-animate="true" id="apiModal">
					<div class="modal-backdrop"></div>
					<div class="modal-background-content">
						<!-- Background content will be copied here -->
					</div>
					<div class="dashboard-modal-content">
						<div class="modal-handle"></div>
						<div class="dashboard-wrapper">
							<!-- API Header -->
							<div class="dashboard-header">
								<div class="dashboard-header-left">
									<div class="dashboard-title-section">
										<h1 class="dashboard-title">API Documentation</h1>
										<p class="dashboard-subtitle">Developer resources and API endpoints</p>
									</div>
								</div>
								<div class="dashboard-header-right">
									<button class="dashboard-close-btn" id="apiClose">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<line x1="18" y1="6" x2="6" y2="18"/>
											<line x1="6" y1="6" x2="18" y2="18"/>
										</svg>
									</button>
								</div>
							</div>

							<!-- API Content -->
							<div class="dashboard-content">
								<div class="api-sections" id="apiSections">
									<!-- API endpoints will be loaded dynamically -->
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="dashboard-modal needs-shadow needs-scrolling" modal-animate="true" id="devToolsModal">
					<div class="modal-backdrop"></div>
					<div class="modal-background-content">
					</div>
					<div class="dashboard-modal-content">
						<div class="modal-handle"></div>
						<div class="dashboard-wrapper">
							<div class="dashboard-header">
								<div class="dashboard-header-left">
									<div class="dashboard-title-section">
										<h1 class="dashboard-title">Developer Tools</h1>
										<p class="dashboard-subtitle">Advanced debugging and development utilities</p>
									</div>
								</div>
								<div class="dashboard-header-right">
									<button class="dashboard-close-btn" id="devToolsClose">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<line x1="18" y1="6" x2="6" y2="18"/>
											<line x1="6" y1="6" x2="18" y2="18"/>
										</svg>
									</button>
								</div>
							</div>

							<!-- Dev Tools Content -->
							<div class="dashboard-content">
								<div class="devtools-sections" id="devToolsSections">
									<!-- Dev tools will be loaded dynamically -->
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="upload-modal needs-shadow" modal-animate="true" id="uploadModal">
					<div class="modal-background-content">
						<div class="container">
							<div class="search-container">
								<div class="search-wrapper">
									<svg
										class="search-icon"
										xmlns="http://www.w3.org/2000/svg"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2"
									>
										<circle cx="11" cy="11" r="8" />
										<path d="m21 21-4.35-4.35" />
									</svg>
									<input type="text" id="searchInputBg" placeholder="Search assets..." class="search-input" disabled />
									<button class="upload-btn" disabled>
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
											<polyline points="17,8 12,3 7,8" />
											<line x1="12" y1="3" x2="12" y2="15" />
										</svg>
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="upload-modal-content">
						<div class="modal-handle"></div>
						<div class="modal-content-wrapper">
							<div class="upload-left-panel">
								<div class="modal-header">
									<h2 class="modal-title">Upload Asset</h2>
									<button class="modal-close" id="modalClose">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
										>
											<line x1="18" y1="6" x2="6" y2="18"></line>
											<line x1="6" y1="6" x2="18" y2="18"></line>
										</svg>
									</button>
								</div>

								<div class="upload-tabs">
									<button class="upload-tab active" data-tab="direct">Direct Upload</button>
									<button class="upload-tab" data-tab="database">Database Storage</button>
								</div>

								<div class="upload-content active" id="directTab">
									<div class="file-drop-zone" id="dropZone">
										<svg
											class="drop-zone-icon"
											xmlns="http://www.w3.org/2000/svg"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
										>
											<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
											<polyline points="17,8 12,3 7,8" />
											<line x1="12" y1="3" x2="12" y2="15" />
										</svg>
										<h3>Drop files here or click to browse</h3>
										<p>Supports images, videos, audio, fonts, and documents</p>
										<input
											type="file"
											id="fileInput"
											style="display: none"
											multiple
											accept="image/*,video/*,audio/*,.css,.js,.json,.html,.woff,.woff2,.ttf,.eot,.otf,.pdf"
										/>
									</div>

									<div id="filePreview"></div>

									<div class="form-group">
										<label class="form-label">Upload Path Hint (Optional)</label>
										<input type="text" class="form-input" id="uploadPath" placeholder="Leave empty for auto-obfuscation" value="" />
										<small style="color: hsl(var(--muted-foreground)); font-size: 0.8rem; margin-top: 0.5rem; display: block">
											Files will be stored with cryptographically obfuscated paths regardless of this setting
										</small>
									</div>

									<div class="upload-progress" id="uploadProgress">
										<div class="progress-bar">
											<div class="progress-fill" id="progressFill"></div>
										</div>
										<div class="progress-text" id="progressText">Uploading...</div>
									</div>
								</div>

								<!-- Database Storage Tab -->
								<div class="upload-content" id="databaseTab">
									<div class="file-drop-zone" id="dropZoneDb">
										<svg
											class="drop-zone-icon"
											xmlns="http://www.w3.org/2000/svg"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
										>
											<ellipse cx="12" cy="5" rx="9" ry="3" />
											<path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
											<path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
										</svg>
										<h3>Store in D1 Database</h3>
										<p>Metadata stored in D1, files in CDN</p>
										<input
											type="file"
											id="fileInputDb"
											style="display: none"
											multiple
											accept="image/*,video/*,audio/*,.css,.js,.json,.html,.woff,.woff2,.ttf,.eot,.otf,.pdf"
										/>
									</div>

									<div id="filePreviewDb"></div>

									<div class="form-group">
										<label class="form-label">Asset Name</label>
										<input type="text" class="form-input" id="assetName" placeholder="Enter asset name" />
									</div>

									<div class="form-group">
										<label class="form-label">Category</label>
										<select class="form-select" id="assetCategory">
											<option value="icons">Icons</option>
											<option value="images">Images</option>
											<option value="media">Media</option>
											<option value="sounds">Sounds</option>
											<option value="backgrounds">Backgrounds</option>
											<option value="placeholders">Placeholders</option>
											<option value="styles">Styles</option>
											<option value="scripts">Scripts</option>
											<option value="fonts">Fonts</option>
											<option value="documents">Documents</option>
											<option value="custom">Custom</option>
										</select>
									</div>

									<div class="form-group">
										<label class="form-label">Description</label>
										<textarea class="form-textarea" id="assetDescription" placeholder="Optional description"></textarea>
									</div>

									<div class="form-group">
										<label class="form-label">Tags (comma-separated)</label>
										<input type="text" class="form-input" id="assetTags" placeholder="tag1, tag2, tag3" />
									</div>

									<div class="upload-progress" id="uploadProgressDb">
										<div class="progress-bar">
											<div class="progress-fill" id="progressFillDb"></div>
										</div>
										<div class="progress-text" id="progressTextDb">Uploading...</div>
									</div>
								</div>

								<div class="modal-actions">
									<button class="btn btn-secondary" id="cancelBtn">Cancel</button>
									<button class="btn btn-primary" id="uploadSubmit">Upload</button>
								</div>
							</div>

							<!-- Right Panel -->
							<div class="upload-right-panel">
								<div class="upload-background-pattern"></div>
								<div class="upload-icon-display" id="uploadIconDisplay">
									<svg
										xmlns="http://www.w3.org/2000/svg"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2"
										stroke-linecap="round"
										stroke-linejoin="round"
									>
										<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
										<polyline points="17,8 12,3 7,8" />
										<line x1="12" y1="3" x2="12" y2="15" />
									</svg>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="file-editor-modal" id="fileEditorModal">
				<div class="modal-background-content">
					<div class="container">
						<div class="search-container">
							<div class="search-wrapper">
								<svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<circle cx="11" cy="11" r="8" />
									<path d="m21 21-4.35-4.35" />
								</svg>
								<input type="text" id="searchInputEditor" placeholder="Search files..." class="search-input" disabled />
								<button class="upload-btn" disabled>
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
										<polyline points="17,8 12,3 7,8" />
										<line x1="12" y1="3" x2="12" y2="15" />
									</svg>
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="file-editor-modal-content">
					<div class="modal-handle"></div>
					<div class="modal-content-wrapper">
						<div class="file-editor-left-panel needs-scrolling">
							<div class="modal-header" style="padding: 0rem 1.5rem  20px 1.5rem; margin-bottom: 0px !important;">
								<div class="editor-header-content">
									<div class="editor-title-group">
										<h2 class="modal-title">Editor</h2>
										<p class="modal-subtitle">Edit files with version control</p>
									</div>
								</div>
								<button class="modal-close" id="fileEditorClose">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<line x1="18" y1="6" x2="6" y2="18"></line>
										<line x1="6" y1="6" x2="18" y2="18"></line>
									</svg>
								</button>
							</div>

							<div class="file-selector-section" style="padding: 0.5rem !important;">
								<div class="file-search-container" style="margin-bottom: 1rem; display: inline-flex; width: 100%; justify-content: space-between; align-items: center; gap: 0.5rem;">
									<div class="search-input-wrapper" style="width: 100%;">
										<svg class="search-icon-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<circle cx="11" cy="11" r="8" />
											<path d="m21 21-4.35-4.35" />
										</svg>
										<input type="text" id="fileSearchInput" placeholder="Search your files..." class="file-search-input" />
									</div>
									<button style="width: 3rem; height: 3rem; border-radius: 18%;" class="refresh-files-btn" id="refreshFilesBtn" title="Refresh file list">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
											<path d="M21 3v5h-5" />
											<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
											<path d="M3 21v-5h5" />
										</svg>
									</button>
								</div>
								<div class="file-list-container needs-scrolling" id="fileListContainer">
									<div class="loading-spinner">
										<div class="spinner"></div>
										<span>Loading files...</span>
									</div>
								</div>
							</div>
							<div class="current-file-section" id="currentFileSection" style="display: none;">
								<div class="section-header">
									<h3>Current File</h3>
									<div class="file-actions-quick">
										<button class="action-btn" id="viewVersionsBtn" title="View version history">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
												<path d="M3 3v5h5" />
											</svg>
										</button>
										<button class="action-btn" id="downloadFileBtn" title="Download file">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15" />
												<polyline points="7,10 12,15 17,10" />
												<line x1="12" y1="15" x2="12" y2="3" />
											</svg>
										</button>
									</div>
								</div>
								<div class="current-file-info" id="currentFileInfo">
									<!-- File info will be populated here -->
								</div>
							</div>

							<!-- Save Actions -->
							<div class="save-actions-section" id="saveActionsSection" style="display: none;">
								<div class="section-header">
									<h3>Save Changes</h3>
								</div>
								<div class="save-options">
									<div class="form-group">
										<label class="form-label">Change Description</label>
										<textarea class="form-textarea" id="changeDescription" placeholder="Describe your changes..." rows="3"></textarea>
									</div>
									<div class="save-buttons">
										<button class="btn btn-secondary" id="discardChangesBtn">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M3 6h18" />
												<path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
												<path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
											</svg>
											Discard
										</button>
										<button class="btn btn-primary" id="saveChangesBtn">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
												<polyline points="17,21 17,13 7,13 7,21" />
												<polyline points="7,3 7,8 15,8" />
											</svg>
											Save Changes
										</button>
									</div>
								</div>
							</div>
						</div>

						<!-- Right Panel - Editor -->
						<div class="file-editor-right-panel">
							<div class="editor-container">
								<!-- Editor Tabs -->
								<div class="editor-tabs" id="editorTabs">
									<div class="editor-tab active" data-tab="content">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
											<polyline points="14,2 14,8 20,8" />
										</svg>
										Content
									</div>
									<div class="editor-tab" data-tab="info">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<circle cx="12" cy="12" r="10" />
											<line x1="12" y1="16" x2="12" y2="12" />
											<line x1="12" y1="8" x2="12.01" y2="8" />
										</svg>
										Info
									</div>
									<div class="editor-tab" data-tab="metadata">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M12.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L12.5 2z" />
											<path d="M14 2v6h6" />
											<path d="M16 13H8" />
											<path d="M16 17H8" />
											<path d="M10 9H8" />
										</svg>
										Metadata
									</div>
									<div class="editor-tab" data-tab="preview">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
											<circle cx="12" cy="12" r="3" />
										</svg>
										Preview
									</div>
								</div>

								<!-- Editor Content Areas -->
								<div class="editor-content-areas">
																	<!-- Content Editor -->
								<div class="editor-area active" id="contentEditor">
									<div class="content-mode-selector" id="contentModeSelector">
										<div class="mode-tabs">
											<button class="mode-tab active" data-mode="viewer" id="viewerModeBtn">
												<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
													<circle cx="12" cy="12" r="3"/>
												</svg>
												Viewer
											</button>
											<button class="mode-tab" data-mode="editor" id="editorModeBtn">
												<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
													<path d="m15 5 4 4"/>
												</svg>
												Editor
											</button>
											<button class="mode-tab" data-mode="advanced" id="advancedModeBtn" style="display: none;">
												<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
													<circle cx="12" cy="12" r="3"/>
												</svg>
												Advanced
											</button>
										</div>
										<div class="content-info" id="contentInfo">
											<span class="content-type-indicator" id="contentTypeIndicator">Select a file</span>
										</div>
									</div>

									<!-- File Viewer Mode -->
									<div class="content-viewer" id="contentViewer">
										<div class="viewer-container" id="viewerContainer">
											<div class="viewer-placeholder">
												<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
													<polyline points="14,2 14,8 20,8"/>
												</svg>
												<h3>Content Viewer</h3>
												<p>Select a file to view its content</p>
											</div>
										</div>
									</div>

									<!-- Text Editor Mode -->
									<div class="content-editor-mode" id="contentEditorMode" style="display: none;">
										<div class="editor-toolbar">
											<div class="toolbar-section">
												<button class="toolbar-btn" id="undoBtn" title="Undo (Ctrl+Z)">
													<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
														<path d="M3 7v6h6" />
														<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />
													</svg>
												</button>
												<button class="toolbar-btn" id="redoBtn" title="Redo (Ctrl+Y)">
													<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
														<path d="M21 7v6h-6" />
														<path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7" />
													</svg>
												</button>
											</div>
											<div class="toolbar-section">
												<button class="toolbar-btn" id="formatBtn" title="Format Code (Ctrl+Shift+F)">
													<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
														<polyline points="16,3 21,3 21,8" />
														<line x1="4" y1="20" x2="21" y2="3" />
														<polyline points="21,16 21,21 16,21" />
														<line x1="15" y1="15" x2="21" y2="21" />
														<line x1="4" y1="4" x2="9" y2="9" />
													</svg>
												</button>
												<button class="toolbar-btn" id="wrapBtn" title="Toggle Word Wrap">
													<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
														<polyline points="3,6 21,6" />
														<polyline points="3,12 15,12" />
														<polyline points="3,18 12,18" />
													</svg>
												</button>
											</div>
											<div class="toolbar-section">
												<select class="language-select" id="languageSelect">
													<option value="auto">Auto-detect</option>
													<option value="javascript">JavaScript</option>
													<option value="typescript">TypeScript</option>
													<option value="html">HTML</option>
													<option value="css">CSS</option>
													<option value="json">JSON</option>
													<option value="markdown">Markdown</option>
													<option value="text">Plain Text</option>
												</select>
											</div>
										</div>
										<div class="code-editor-container">
											<div class="line-numbers" id="lineNumbers"></div>
											<textarea class="code-editor" id="codeEditor" placeholder="Select a file to start editing..."></textarea>
										</div>
										<div class="editor-status-bar">
											<div class="status-left">
												<span class="status-item" id="cursorPosition">Line 1, Column 1</span>
												<span class="status-item" id="fileSize">0 bytes</span>
												<span class="status-item" id="changeStatus">No changes</span>
											</div>
											<div class="status-right">
												<span class="status-item" id="encoding">UTF-8</span>
												<span class="status-item" id="fileType">Plain Text</span>
											</div>
										</div>
									</div>
								</div>

									<!-- Advanced Editor Mode -->
									<div class="editor-area" id="advancedEditorMode" style="display: none;">
										<div class="advanced-editor-container">
											<div class="advanced-editor-header">
												<h3>Advanced Editor</h3>
												<div class="editor-type-selector" id="editorTypeSelector">
													<button class="editor-type-btn" data-type="iframe" id="iframeEditorBtn">
														<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
															<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
															<line x1="8" y1="21" x2="16" y2="21"/>
															<line x1="12" y1="17" x2="12" y2="21"/>
														</svg>
														Web Editor
													</button>
													<button class="editor-type-btn" data-type="api" id="apiEditorBtn">
														<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
															<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
															<circle cx="12" cy="12" r="3"/>
														</svg>
														API Editor
													</button>
												</div>
											</div>

											<!-- Iframe Editor -->
											<div class="advanced-editor-content" id="iframeEditorContent">
												<div class="iframe-editor-info">
													<div class="editor-info-card">
														<h4>Web-based Editor</h4>
														<p>Edit your file using powerful online editors tailored for your file type.</p>
														<div class="supported-types">
															<span class="type-badge" data-type="pdf">PDF</span>
															<span class="type-badge" data-type="image">Images</span>
															<span class="type-badge" data-type="audio">Audio</span>
															<span class="type-badge" data-type="code">Code</span>
														</div>
													</div>
												</div>
												<div class="iframe-editor-actions">
													<button class="btn btn-primary" id="openIframeEditorBtn">
														<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
															<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
															<polyline points="15,3 21,3 21,9"/>
															<line x1="10" y1="14" x2="21" y2="3"/>
														</svg>
														Open Web Editor
													</button>
												</div>
												<div class="iframe-editor-container" id="iframeEditorContainer" style="display: none;">
													<iframe id="advancedEditorFrame" src="" frameborder="0"></iframe>
												</div>
											</div>

											<!-- API Editor -->
											<div class="advanced-editor-content" id="apiEditorContent" style="display: none;">
												<div class="api-editor-info">
													<div class="editor-info-card">
														<h4>Server-side Processing</h4>
														<p>Apply advanced editing operations using our server-side APIs.</p>
													</div>
												</div>

												<!-- PDF Operations -->
												<div class="operation-group" id="pdfOperations" style="display: none;">
													<h5>PDF Operations</h5>
													<div class="operation-buttons">
														<button class="operation-btn" data-operation="add-text">Add Text</button>
														<button class="operation-btn" data-operation="add-image">Add Image</button>
														<button class="operation-btn" data-operation="rotate">Rotate Pages</button>
														<button class="operation-btn" data-operation="merge">Merge PDFs</button>
														<button class="operation-btn" data-operation="split">Split PDF</button>
													</div>
												</div>

												<!-- Image Operations -->
												<div class="operation-group" id="imageOperations" style="display: none;">
													<h5>Image Operations</h5>
													<div class="operation-buttons">
														<button class="operation-btn" data-operation="resize">Resize</button>
														<button class="operation-btn" data-operation="crop">Crop</button>
														<button class="operation-btn" data-operation="rotate">Rotate</button>
														<button class="operation-btn" data-operation="filter">Apply Filter</button>
														<button class="operation-btn" data-operation="compress">Compress</button>
													</div>
												</div>

												<!-- Audio Operations -->
												<div class="operation-group" id="audioOperations" style="display: none;">
													<h5>Audio Operations</h5>
													<div class="operation-buttons">
														<button class="operation-btn" data-operation="trim">Trim</button>
														<button class="operation-btn" data-operation="normalize">Normalize</button>
														<button class="operation-btn" data-operation="fade">Add Fade</button>
														<button class="operation-btn" data-operation="convert">Convert Format</button>
														<button class="operation-btn" data-operation="merge">Merge Audio</button>
													</div>
												</div>

												<div class="operation-config" id="operationConfig" style="display: none;">
													<h5>Operation Settings</h5>
													<div class="config-form" id="configForm">
														<!-- Dynamic form will be generated here -->
													</div>
													<div class="operation-actions">
														<button class="btn btn-primary" id="executeOperationBtn">Execute Operation</button>
														<button class="btn btn-secondary" id="cancelOperationBtn">Cancel</button>
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Info Area -->
									<div class="editor-area" id="infoArea">
										<div class="info-container">
											<div class="info-section">
												<h4>File Information</h4>
												<div class="info-grid">
													<div class="info-item">
														<span class="info-label">File Name:</span>
														<span class="info-value" id="infoFileName">-</span>
													</div>
													<div class="info-item">
														<span class="info-label">File Size:</span>
														<span class="info-value" id="infoFileSize">-</span>
													</div>
													<div class="info-item">
														<span class="info-label">MIME Type:</span>
														<span class="info-value" id="infoMimeType">-</span>
													</div>
													<div class="info-item">
														<span class="info-label">Created:</span>
														<span class="info-value" id="infoCreated">-</span>
													</div>
													<div class="info-item">
														<span class="info-label">Modified:</span>
														<span class="info-value" id="infoModified">-</span>
													</div>
													<div class="info-item">
														<span class="info-label">File ID:</span>
														<span class="info-value" id="infoFileId">-</span>
													</div>
												</div>
											</div>

											<div class="info-section">
												<div class="info-section-header">
													<h4>Version History</h4>
													<button class="refresh-versions-btn" id="refreshVersionsBtn" title="Refresh versions">
														<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
															<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
															<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
														</svg>
													</button>
												</div>
												<div class="versions-container" id="versionsContainer">
													<div class="versions-loading">
														<div class="spinner"></div>
														<span>Loading versions...</span>
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Metadata Editor -->
									<div class="editor-area" id="metadataEditor">
										<div class="metadata-form">
											<div class="form-section">
												<h4>Basic Information</h4>
												<div class="form-group">
													<label class="form-label">File Name</label>
													<input type="text" class="form-input" id="metaFileName" placeholder="Enter file name" />
												</div>
												<div class="form-group">
													<label class="form-label">Description</label>
													<textarea class="form-textarea" id="metaDescription" placeholder="Describe this file..." rows="3"></textarea>
												</div>
											</div>

											<div class="form-section">
												<h4>Organization</h4>
												<div class="form-group">
													<label class="form-label">Category</label>
													<select class="form-select" id="metaCategory">
														<option value="">Select category</option>
														<option value="icons">Icons</option>
														<option value="images">Images</option>
														<option value="media">Media</option>
														<option value="sounds">Sounds</option>
														<option value="backgrounds">Backgrounds</option>
														<option value="styles">Styles</option>
														<option value="scripts">Scripts</option>
														<option value="fonts">Fonts</option>
														<option value="documents">Documents</option>
														<option value="custom">Custom</option>
													</select>
												</div>
												<div class="form-group">
													<label class="form-label">Tags</label>
													<div class="tags-input-container">
														<input type="text" class="form-input" id="metaTags" placeholder="Add tags (press Enter)" />
														<div class="tags-display" id="tagsDisplay"></div>
													</div>
												</div>
											</div>

											<div class="form-section">
												<h4>Custom Fields</h4>
												<div class="custom-fields-container" id="customFieldsContainer">
													<button class="add-field-btn" id="addCustomFieldBtn">
														<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
															<line x1="12" y1="5" x2="12" y2="19" />
															<line x1="5" y1="12" x2="19" y2="12" />
														</svg>
														Add Custom Field
													</button>
												</div>
											</div>
										</div>
									</div>

									<!-- Preview Area -->
									<div class="editor-area" id="previewArea">
										<div class="preview-container" id="previewContainer">
											<div class="preview-placeholder">
												<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
													<circle cx="12" cy="12" r="3" />
												</svg>
												<h3>File Preview</h3>
												<p>Select a file to see its preview</p>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="success-modal" id="successModal">
				<div class="success-modal-content">
					<div class="success-checkmark">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="3"
							stroke-linecap="round"
							stroke-linejoin="round"
						>
							<polyline points="20,6 9,17 4,12" />
						</svg>
					</div>

					<h1 class="success-title">Upload Successful!</h1>
					<p class="success-subtitle">Your asset has been uploaded and is now available on the CDN</p>

					<div class="server-details">
						<h3>Server & Service Details</h3>
						<div class="detail-row">
							<span class="detail-label">CDN Service</span>
							<span class="detail-value">JWLimited Professional CDN</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">Edge Network</span>
							<span class="detail-value">Cloudflare Global</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">Storage Method</span>
							<span class="detail-value" id="storageMethod">Direct Upload</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">Obfuscated URL</span>
							<span class="detail-value" id="assetUrl" style="font-family: monospace; font-size: 0.85rem; word-break: break-all"
								>Processing...</span
							>
						</div>
						<div class="detail-row" id="originalPathRow" style="display: none">
							<span class="detail-label">Original Path Hint</span>
							<span class="detail-value" id="originalPath" style="font-family: monospace; font-size: 0.85rem">-</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">File Size</span>
							<span class="detail-value" id="fileSize">0 bytes</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">Upload Time</span>
							<span class="detail-value" id="uploadTime">Just now</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">Cache Status</span>
							<span class="detail-value">Cached & Optimized</span>
						</div>
					</div>

					<div class="success-actions">
						<button class="btn btn-primary" id="copyUrlBtn">Copy URL</button>
						<button class="btn btn-secondary" id="viewAssetBtn">View Asset</button>
						<button class="btn btn-secondary" id="closeSuccessBtn">Close</button>
					</div>
				</div>
			</div>

			<div class="file-viewer-panel" id="fileViewerPanel">
				<div class="file-viewer-header">
					<div class="file-viewer-title-section">
						<div class="file-viewer-icon">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
							</svg>
						</div>
						<div class="file-viewer-title-text">
							<h3 class="file-viewer-title">Files</h3>
							<p class="file-viewer-subtitle">Your uploaded assets</p>
						</div>
					</div>
					<div class="file-viewer-actions">
						<button class="file-viewer-refresh" id="fileViewerRefresh" title="Refresh">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
								<path d="M21 3v5h-5"/>
								<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
								<path d="M3 21v-5h5"/>
							</svg>
						</button>
						<button class="file-viewer-close" id="fileViewerClose" title="Close">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<line x1="18" y1="6" x2="6" y2="18"/>
								<line x1="6" y1="6" x2="18" y2="18"/>
							</svg>
						</button>
					</div>
				</div>
				<div class="file-viewer-content">
					<div class="file-viewer-stats">
						<div class="file-stat">
							<span class="file-stat-value" id="fileStatCount">0</span>
							<span class="file-stat-label">Files</span>
						</div>
						<div class="file-stat">
							<span class="file-stat-value" id="fileStatSize">0 B</span>
							<span class="file-stat-label">Used</span>
						</div>
					</div>
					<div class="file-viewer-list" id="fileViewerList">
						<!-- Files will be loaded here -->
					</div>
				</div>
			</div>
		</div>
		<script>
			class AssetSearch {
				constructor() {
					this.searchInput = document.getElementById('searchInput');
					this.loadingSpinner = document.getElementById('loadingSpinner');
					this.resultsContainer = document.getElementById('resultsContainer');
					this.resultsGrid = document.getElementById('resultsGrid');

					this.debounceTimer = null;
					this.cache = new Map();

					// Upload modal elements
					this.uploadBtn = document.getElementById('uploadBtn');
					this.uploadModal = document.getElementById('uploadModal');
					this.modalClose = document.getElementById('modalClose');
					this.cancelBtn = document.getElementById('cancelBtn');
					this.uploadSubmit = document.getElementById('uploadSubmit');
					this.uploadIconDisplay = document.getElementById('uploadIconDisplay');

					// Success modal elements
					this.successModal = document.getElementById('successModal');
					this.copyUrlBtn = document.getElementById('copyUrlBtn');
					this.viewAssetBtn = document.getElementById('viewAssetBtn');
					this.closeSuccessBtn = document.getElementById('closeSuccessBtn');

					this.currentTab = 'direct';
					this.selectedFiles = [];
					this.lastUploadResult = null;

					//this.init();
					this.initUpload();
				}

				init() {
					this.searchInput.addEventListener('input', (e) => {
						this.handleSearch(e.target.value);
					});

					this.searchInput.addEventListener('keydown', (e) => {
						if (e.key === 'Enter') {
							e.preventDefault();
							this.handleSearch(e.target.value, true);
						}
					});

					// Focus search on load
					this.searchInput.focus();

					// Keyboard shortcuts
					document.addEventListener('keydown', (e) => {
						if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
							e.preventDefault();
							this.searchInput.focus();
							this.searchInput.select();
						}
					});
				}

				handleSearch(query, immediate = false) {
					clearTimeout(this.debounceTimer);

					if (!query.trim()) {
						this.hideResults();
						return;
					}

					const delay = immediate ? 0 : 300;

					this.debounceTimer = setTimeout(() => {
						this.performSearch(query.trim());
					}, delay);
				}

				async performSearch(query) {
					if (this.cache.has(query)) {
						this.displayResults(this.cache.get(query), query);
						return;
					}

					this.showLoading();

					try {
						const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=12`);
						const data = await response.json();

						if (response.ok) {
							this.cache.set(query, data.results || []);
							this.displayResults(data.results || [], query);
						} else {
							this.displayError(data.error || 'Search failed');
						}
					} catch (error) {
						console.error('Search error:', error);
						this.displayError('Network error occurred');
					} finally {
						this.hideLoading();
					}
				}

				displayResults(results, query) {
					this.resultsGrid.innerHTML = '';

					if (results.length === 0) {
						this.displayNoResults(query);
						return;
					}

					results.forEach((result, index) => {
						const card = this.createResultCard(result, index);
						this.resultsGrid.appendChild(card);
					});

					this.showResults();
				}

				createResultCard(result, index) {
					const card = document.createElement('div');
					card.className = 'result-card';
					card.style.animationDelay = `${index * 50}ms`;

					const icon = this.getFileIcon(result.type);
					const size = result.size ? this.formatFileSize(result.size) : '';
					const modified = result.lastModified ? this.formatDate(result.lastModified) : '';

					card.innerHTML = `
                    <div class="result-icon">${icon}</div>
                    <div class="result-title">${this.escapeHtml(result.name)}</div>
                    <div class="result-path">${this.escapeHtml(result.path)}</div>
                    <div class="result-meta">
                        <span class="result-tag">${result.type}</span>
                        ${size ? `<span class="result-tag">${size}</span>` : ''}
                        ${modified ? `<span class="result-tag">${modified}</span>` : ''}
                    </div>
                `;

					card.addEventListener('click', () => {
						this.openAsset(result.path);
					});

					return card;
				}

				getFileIcon(type) {
					const icons = {
						image: '🖼️',
						font: '🔤',
						css: '🎨',
						js: '⚡',
						json: '📋',
						html: '🌐',
						video: '🎬',
						audio: '🎵',
						document: '📄',
						archive: '📦',
					};
					return icons[type] || '📄';
				}

				formatFileSize(bytes) {
					if (bytes === 0) return '0 B';
					const k = 1024;
					const sizes = ['B', 'KB', 'MB', 'GB'];
					const i = Math.floor(Math.log(bytes) / Math.log(k));
					return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
				}

				formatDate(timestamp) {
					const date = new Date(timestamp);
					const now = new Date();
					const diff = now - date;
					const days = Math.floor(diff / (1000 * 60 * 60 * 24));

					if (days === 0) return 'Today';
					if (days === 1) return 'Yesterday';
					if (days < 7) return `${days}d ago`;
					return date.toLocaleDateString();
				}

				displayNoResults(query) {
					this.resultsGrid.innerHTML = `
                    <div class="no-results">
                        <svg class="no-results-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                            <path d="M11 8v3"/>
                            <path d="M11 14h.01"/>
                        </svg>
                        <p>No assets found for "${this.escapeHtml(query)}"</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">Try different keywords or browse our asset categories</p>
                    </div>
                `;
					this.showResults();
				}

				displayError(message) {
					this.resultsGrid.innerHTML = `
                    <div class="no-results">
                        <p style="color: hsl(var(--destructive));">⚠️ ${this.escapeHtml(message)}</p>
                    </div>
                `;
					this.showResults();
				}

				openAsset(path) {
					// Create a temporary link and click it to open/download the asset
					const link = document.createElement('a');
					link.href = path;
					link.target = '_blank';
					link.rel = 'noopener noreferrer';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
				}

				showLoading() {
					this.loadingSpinner.classList.add('active');
				}

				hideLoading() {
					this.loadingSpinner.classList.remove('active');
				}

				showResults() {
					this.resultsContainer.classList.add('show');
				}

				hideResults() {
					this.resultsContainer.classList.remove('show');
				}

				escapeHtml(text) {
					const div = document.createElement('div');
					div.textContent = text;
					return div.innerHTML;
				}

				// Upload functionality
				initUpload() {
					// Upload button click
					this.uploadBtn.addEventListener('click', () => {
						this.showUploadModal();
					});

					// Modal close events
					this.modalClose.addEventListener('click', () => {
						this.hideUploadModal();
					});

					this.cancelBtn.addEventListener('click', () => {
						this.hideUploadModal();
					});

					// Click outside modal to close
					this.uploadModal.addEventListener('click', (e) => {
						if (e.target === this.uploadModal) {
							this.hideUploadModal();
						}
					});

					// Tab switching
					document.querySelectorAll('.upload-tab').forEach((tab) => {
						tab.addEventListener('click', (e) => {
							this.switchTab(e.target.dataset.tab);
						});
					});

					// File drop zones
					this.initDropZone('dropZone', 'fileInput', 'filePreview');
					this.initDropZone('dropZoneDb', 'fileInputDb', 'filePreviewDb');

					// Upload submit
					this.uploadSubmit.addEventListener('click', () => {
						this.handleUpload();
					});

					// ESC key to close modal
					document.addEventListener('keydown', (e) => {
						if (e.key === 'Escape') {
							if (this.successModal.classList.contains('show')) {
								this.hideSuccessModal();
							} else if (this.uploadModal.classList.contains('show')) {
								this.hideUploadModal();
							}
						}
					});

					// Success modal events
					this.copyUrlBtn.addEventListener('click', () => {
						this.copyAssetUrl();
					});

					this.viewAssetBtn.addEventListener('click', () => {
						this.viewAsset();
					});

					this.closeSuccessBtn.addEventListener('click', () => {
						this.hideSuccessModal();
					});
				}

				initDropZone(dropZoneId, fileInputId, previewId) {
					const dropZone = document.getElementById(dropZoneId);
					const fileInput = document.getElementById(fileInputId);
					const preview = document.getElementById(previewId);

					// Click to browse
					dropZone.addEventListener('click', () => {
						fileInput.click();
					});

					// File input change
					fileInput.addEventListener('change', (e) => {
						this.handleFiles(e.target.files, previewId);
					});

					// Drag and drop
					dropZone.addEventListener('dragover', (e) => {
						e.preventDefault();
						dropZone.classList.add('dragover');
					});

					dropZone.addEventListener('dragleave', () => {
						dropZone.classList.remove('dragover');
					});

					dropZone.addEventListener('drop', (e) => {
						e.preventDefault();
						dropZone.classList.remove('dragover');
						this.handleFiles(e.dataTransfer.files, previewId);
					});
				}

				showUploadModal() {
					this.uploadModal.classList.add('show');
					document.body.style.overflow = 'hidden';
				}

				hideUploadModal() {
					this.uploadModal.classList.remove('show');
					document.body.style.overflow = '';
					this.resetUploadForm();
				}

				switchTab(tab) {
					this.currentTab = tab;

					// Update tab buttons
					document.querySelectorAll('.upload-tab').forEach((t) => {
						t.classList.remove('active');
					});
					document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

					// Update content
					document.querySelectorAll('.upload-content').forEach((content) => {
						content.classList.remove('active');
					});
					document.getElementById(tab === 'direct' ? 'directTab' : 'databaseTab').classList.add('active');

					// Update right panel icon
					this.updateUploadIcon(tab);

					this.resetUploadForm();
				}

				updateUploadIcon(tab) {
					const iconDisplay = this.uploadIconDisplay;

					if (tab === 'direct') {
						iconDisplay.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17,8 12,3 7,8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                    `;
					} else {
						iconDisplay.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <ellipse cx="12" cy="5" rx="9" ry="3"/>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                        </svg>
                    `;
					}
				}

				handleFiles(files, previewId) {
					this.selectedFiles = Array.from(files);
					this.updateFilePreview(previewId);

					// Auto-populate fields for database tab
					if (this.currentTab === 'database' && files.length > 0) {
						const firstFile = files[0];
						const nameInput = document.getElementById('assetName');
						if (!nameInput.value) {
							nameInput.value = firstFile.name.replace(/\.[^/.]+$/, '');
						}
					}

					// Activate right panel icon
					this.uploadIconDisplay.classList.add('active');
				}

				updateFilePreview(previewId) {
					const preview = document.getElementById(previewId);
					preview.innerHTML = '';

					this.selectedFiles.forEach((file) => {
						const fileDiv = document.createElement('div');
						fileDiv.className = 'file-preview';

						const icon = this.getFileIconSvg(file.type);
						const size = this.formatFileSize(file.size);

						fileDiv.innerHTML = `
                        <div class="file-preview-icon">${icon}</div>
                        <div class="file-preview-info">
                            <div class="file-preview-name">${this.escapeHtml(file.name)}</div>
                            <div class="file-preview-size">${size}</div>
                        </div>
                    `;

						preview.appendChild(fileDiv);
					});
				}

				getFileIconSvg(mimeType) {
					if (mimeType.startsWith('image/')) {
						return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>';
					} else if (mimeType.startsWith('video/')) {
						return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>';
					} else if (mimeType.startsWith('audio/')) {
						return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
					} else if (mimeType.includes('css')) {
						return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>';
					} else if (mimeType.includes('javascript')) {
						return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>';
					}
					return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>';
				}

				async handleUpload() {
					if (this.selectedFiles.length === 0) {
						alert('Please select files to upload');
						return;
					}

					this.uploadSubmit.disabled = true;

					try {
						if (this.currentTab === 'direct') {
							await this.handleDirectUpload();
						} else {
							await this.handleDatabaseUpload();
						}

						// Success - close modal and show success
						this.hideUploadModal();
						this.cache.clear(); // Clear search cache

						// Show success modal with details
						this.showSuccessModal(this.lastUploadResult);
					} catch (error) {
						console.error('Upload error:', error);
						alert('Upload failed: ' + error.message);
					} finally {
						this.uploadSubmit.disabled = false;
					}
				}

				async handleDirectUpload() {
					const uploadPathHint = document.getElementById('uploadPath').value || '';
					const progressEl = document.getElementById('uploadProgress');
					const progressFill = document.getElementById('progressFill');
					const progressText = document.getElementById('progressText');

					progressEl.style.display = 'block';

					for (let i = 0; i < this.selectedFiles.length; i++) {
						const file = this.selectedFiles[i];
						const fileName = file.name;

						progressText.textContent = `Uploading ${fileName} with obfuscated naming (${i + 1}/${this.selectedFiles.length})`;

						const formData = new FormData();
						formData.append('file', file);
						formData.append('path', uploadPathHint); // Optional hint for path generation

						const response = await fetch('/api/upload/direct', {
							method: 'POST',
							body: formData,
						});

						if (!response.ok) {
							throw new Error(`Failed to upload ${fileName}: ${response.statusText}`);
						}

						const result = await response.json();
						this.lastUploadResult = {
							...result,
							method: 'Direct Upload (Obfuscated)',
							fileName: fileName,
							obfuscatedPath: result.path,
							originalPathHint: result.originalPath || uploadPathHint,
						};

						const progress = ((i + 1) / this.selectedFiles.length) * 100;
						progressFill.style.width = `${progress}%`;
					}

					progressEl.style.display = 'none';
				}

				async handleDatabaseUpload() {
					const assetName = document.getElementById('assetName').value;
					const category = document.getElementById('assetCategory').value;
					const description = document.getElementById('assetDescription').value;
					const tags = document.getElementById('assetTags').value;

					if (!assetName.trim()) {
						throw new Error('Asset name is required');
					}

					const progressEl = document.getElementById('uploadProgressDb');
					const progressFill = document.getElementById('progressFillDb');
					const progressText = document.getElementById('progressTextDb');

					progressEl.style.display = 'block';

					for (let i = 0; i < this.selectedFiles.length; i++) {
						const file = this.selectedFiles[i];

						progressText.textContent = `Uploading ${file.name} to database (${i + 1}/${this.selectedFiles.length})`;

						const formData = new FormData();
						formData.append('file', file);
						formData.append('name', assetName);
						formData.append('category', category);
						formData.append('description', description);
						formData.append('tags', tags);

						const response = await fetch('/api/upload/database', {
							method: 'POST',
							body: formData,
						});

						if (!response.ok) {
							throw new Error(`Failed to upload ${file.name}: ${response.statusText}`);
						}

						const result = await response.json();
						this.lastUploadResult = {
							...result,
							method: 'Database Storage (Obfuscated)',
							fileName: file.name,
							obfuscatedPath: result.path,
							originalCategory: result.originalCategory,
						};

						const progress = ((i + 1) / this.selectedFiles.length) * 100;
						progressFill.style.width = `${progress}%`;
					}

					progressEl.style.display = 'none';
				}

				showSuccessModal(uploadResult) {
					if (!uploadResult) return;

					// Update success modal content
					document.getElementById('storageMethod').textContent = uploadResult.method || uploadResult.file?.method || 'Upload';
					document.getElementById('assetUrl').textContent =
						uploadResult.file?.path || uploadResult.obfuscatedPath || uploadResult.path || uploadResult.url || 'Processing...';
					document.getElementById('fileSize').textContent = this.formatFileSize(uploadResult.file?.size || uploadResult.size || 0);
					document.getElementById('uploadTime').textContent = new Date().toLocaleTimeString();

					// Show original path hint if available
					const originalPathRow = document.getElementById('originalPathRow');
					const originalPathElement = document.getElementById('originalPath');
					if (uploadResult.originalPathHint || uploadResult.originalCategory) {
						const originalInfo = uploadResult.originalPathHint || `/assets/uploads/${uploadResult.originalCategory}/`;
						originalPathElement.textContent = originalInfo;
						originalPathRow.style.display = 'flex';
					} else {
						originalPathRow.style.display = 'none';
					}

					// Show success modal
					this.successModal.classList.add('show');
					document.body.style.overflow = 'hidden';
				}

				hideSuccessModal() {
					this.successModal.classList.remove('show');
					document.body.style.overflow = '';
				}

				copyAssetUrl() {
					const urlElement = document.getElementById('assetUrl');
					const url = urlElement.textContent;

					if (url && url !== 'Processing...') {
						const fullUrl = url.startsWith('http') ? url : `${window.location.origin}${url}`;
						navigator.clipboard
							.writeText(fullUrl)
							.then(() => {
								// Temporarily change button text
								const originalText = this.copyUrlBtn.textContent;
								this.copyUrlBtn.textContent = 'Copied!';
								setTimeout(() => {
									this.copyUrlBtn.textContent = originalText;
								}, 2000);
							})
							.catch(() => {
								alert('Failed to copy URL to clipboard');
							});
					}
				}

				viewAsset() {
					const urlElement = document.getElementById('assetUrl');
					const url = urlElement.textContent;

					if (url && url !== 'Processing...') {
						const fullUrl = url.startsWith('http') ? url : `${window.location.origin}${url}`;
						window.open(fullUrl, '_blank');
					}
				}

				resetUploadForm() {
					this.selectedFiles = [];
					document.getElementById('filePreview').innerHTML = '';
					document.getElementById('filePreviewDb').innerHTML = '';
					document.getElementById('uploadPath').value = '/assets/custom/';
					document.getElementById('assetName').value = '';
					document.getElementById('assetDescription').value = '';
					document.getElementById('assetTags').value = '';
					document.getElementById('uploadProgress').style.display = 'none';
					document.getElementById('uploadProgressDb').style.display = 'none';
					document.getElementById('progressFill').style.width = '0%';
					document.getElementById('progressFillDb').style.width = '0%';
					this.uploadIconDisplay.classList.remove('active');
				}
			}

					// SXAP Authentication Class
		class SXAPAuth {
			constructor() {
				this.baseUrl = window.location.origin;
				this.token = null;
				this.user = null;
				this.isLoginMode = true;
				this.verificationToken = null;

				this.initializeElements();
				this.setupEventListeners();
				this.loadSession();
				this.updateUI();
			}

			initializeElements() {
				// Auth UI elements
				this.authLoggedOut = document.getElementById('authLoggedOut');
				this.authLoggedIn = document.getElementById('authLoggedIn');
				this.loginBtn = document.getElementById('loginBtn');
				this.registerBtn = document.getElementById('registerBtn');
				this.logoutBtn = document.getElementById('logoutBtn');
				this.dashboardBtn = document.getElementById('dashboardBtn');
				this.fileViewerBtn = document.getElementById('fileViewerBtn');
				this.usernameEl = document.getElementById('username');
				this.userRoleEl = document.getElementById('userRole');
				this.userInitialsEl = document.getElementById('userInitials');
				this.userMenuTrigger = document.getElementById('userMenuTrigger');
				this.userDropdown = document.getElementById('userDropdown');

				// Auth modal elements
				this.authModal = document.getElementById('authModal');
				this.authForm = document.getElementById('authForm');
				this.authModalTitle = document.getElementById('authModalTitle');
				this.authModalSubtitle = document.getElementById('authModalSubtitle');
				this.authUsername = document.getElementById('authUsername');
				this.authEmail = document.getElementById('authEmail');
				this.authPassword = document.getElementById('authPassword');
				this.authTotp = document.getElementById('authTotp');
				this.authSubmit = document.getElementById('authSubmit');
				this.authCloseBtn = document.getElementById('authCloseBtn');
				this.authMessage = document.getElementById('authMessage');
				this.authSwitchText = document.getElementById('authSwitchText');
				this.authSwitchBtn = document.getElementById('authSwitchBtn');
				this.emailGroup = document.getElementById('emailGroup');
				this.totpGroup = document.getElementById('totpGroup');
				this.authBtnText = this.authSubmit.querySelector('.auth-btn-text');
				this.authBtnLoading = this.authSubmit.querySelector('.auth-btn-loading');

				// Dashboard modal elements
				this.dashboardModal = document.getElementById('dashboardModal');
				this.dashboardClose = document.getElementById('dashboardClose');
				this.dashboardStats = document.getElementById('dashboardStats');
				this.userUploads = document.getElementById('userUploads');

				// File viewer elements
				this.fileViewerPanel = document.getElementById('fileViewerPanel');
				this.fileViewerClose = document.getElementById('fileViewerClose');
				this.fileViewerRefresh = document.getElementById('fileViewerRefresh');
				this.fileViewerList = document.getElementById('fileViewerList');
				this.fileStatCount = document.getElementById('fileStatCount');
				this.fileStatSize = document.getElementById('fileStatSize');
			}

			setupEventListeners() {
				this.loginBtn.addEventListener('click', () => this.showAuthModal(true));
				this.registerBtn.addEventListener('click', () => this.showAuthModal(false));
				this.logoutBtn.addEventListener('click', () => this.logout());
				this.dashboardBtn.addEventListener('click', () => this.showDashboard());
				this.fileViewerBtn.addEventListener('click', () => this.showFileViewer());

				// User menu dropdown
				this.userMenuTrigger.addEventListener('click', (e) => {
					e.stopPropagation();
					this.toggleUserDropdown();
				});

				this.authCloseBtn.addEventListener('click', () => this.hideAuthModal());
				this.authSwitchBtn.addEventListener('click', () => this.toggleAuthMode());
				this.authForm.addEventListener('submit', (e) => this.handleAuthSubmit(e));

				this.dashboardClose.addEventListener('click', () => this.hideDashboard());
				this.fileViewerClose.addEventListener('click', () => this.hideFileViewer());
				this.fileViewerRefresh.addEventListener('click', () => this.refreshFileViewer());

				// Close modals on backdrop click
				this.authModal.addEventListener('click', (e) => {
					if (e.target === this.authModal || e.target.classList.contains('modal-backdrop')) {
						this.hideAuthModal();
					}
				});
				this.dashboardModal.addEventListener('click', (e) => {
					if (e.target === this.dashboardModal) this.hideDashboard();
				});

				// Close dropdown when clicking outside
				document.addEventListener('click', () => {
					this.hideUserDropdown();
				});
			}

			toggleUserDropdown() {
				this.userDropdown.classList.toggle('show');
			}

			hideUserDropdown() {
				this.userDropdown.classList.remove('show');
			}

			showAuthModal(isLogin = true) {
				this.isLoginMode = isLogin;
				this.updateAuthModal();
				this.copyBackgroundContent();
				this.authModal.classList.add('show');
				this.clearAuthForm();
				document.body.style.overflow = 'hidden';
			}

			hideAuthModal() {
				this.authModal.classList.remove('show');
				this.clearAuthForm();
				this.totpGroup.style.display = 'none';
				this.verificationToken = null;
				document.body.style.overflow = '';
			}

			copyBackgroundContent() {
				const backgroundContent = this.authModal.querySelector('.modal-background-content');
				const mainContent = document.querySelector('.container');
				if (backgroundContent && mainContent) {
					backgroundContent.innerHTML = mainContent.outerHTML;
				}
			}

			updateAuthModal() {
				if (this.isLoginMode) {
					this.authModalTitle.textContent = 'Sign in';
					this.authModalSubtitle.textContent = 'Welcome back to JWLimited CDN';
					this.authBtnText.textContent = 'Sign in';
					this.emailGroup.style.display = 'none';
					this.authSwitchText.textContent = "Don't have an account?";
					this.authSwitchBtn.textContent = 'Get started';
					this.authEmail.required = false;
				} else {
					this.authModalTitle.textContent = 'Get started';
					this.authModalSubtitle.textContent = 'Create your JWLimited CDN account';
					this.authBtnText.textContent = 'Create account';
					this.emailGroup.style.display = 'flex';
					this.authSwitchText.textContent = 'Already have an account?';
					this.authSwitchBtn.textContent = 'Sign in';
					this.authEmail.required = true;
				}
			}

			toggleAuthMode() {
				this.isLoginMode = !this.isLoginMode;
				this.updateAuthModal();
				this.clearAuthForm();
			}

			clearAuthForm() {
				this.authUsername.value = '';
				this.authEmail.value = '';
				this.authPassword.value = '';
				this.authTotp.value = '';
				this.authMessage.innerHTML = '';
			}

			async handleAuthSubmit(e) {
				e.preventDefault();
				this.authSubmit.disabled = true;
				this.authMessage.innerHTML = '';
				this.setLoadingState(true);

				try {
					if (this.verificationToken) {
						await this.verify2FA();
					} else if (this.isLoginMode) {
						await this.login();
					} else {
						await this.register();
					}
				} catch (error) {
					this.showAuthError(error.message);
				} finally {
					this.authSubmit.disabled = false;
					this.setLoadingState(false);
				}
			}

			setLoadingState(loading) {
				if (loading) {
					this.authBtnText.style.display = 'none';
					this.authBtnLoading.style.display = 'flex';
				} else {
					this.authBtnText.style.display = 'block';
					this.authBtnLoading.style.display = 'none';
				}
			}

			async login() {
				const credentials = {
					username: this.authUsername.value,
					password: this.authPassword.value,
					deviceInfo: {
						userAgent: navigator.userAgent,
						platform: navigator.platform
					}
				};

				const response = await fetch(`${this.baseUrl}/api/auth/v2/auth?op=auth&mode=strict&sec=2`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(credentials)
				});

				const result = await response.json();

				if (result.requiresTOTP) {
					this.verificationToken = result.verificationToken;
					this.totpGroup.style.display = 'block';
					this.authBtnText.textContent = 'Verify 2FA';
					this.showAuthMessage('Please enter your 2FA code', 'success');
					return;
				}

				if (result.message === "Login successful") {
					this.token = result.sxap_token;
					this.user = result.user;
					this.saveSession();
					this.updateUI();
					this.hideAuthModal();
					this.showAuthMessage('Login successful!', 'success');
				} else {
					throw new Error(result.message || 'Login failed');
				}
			}

			async register() {
				const userData = {
					username: this.authUsername.value,
					email: this.authEmail.value,
					password: this.authPassword.value
				};

				const response = await fetch(`${this.baseUrl}/api/auth/v2/auth?op=register&mode=strict&sec=2`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(userData)
				});

				const result = await response.json();

				if (result.success) {
					this.token = result.sxap_token;
					this.user = result.user;
					this.saveSession();
					this.updateUI();
					this.hideAuthModal();
					this.showAuthMessage('Registration successful!', 'success');
				} else {
					throw new Error(result.message || 'Registration failed');
				}
			}

			async verify2FA() {
				const totpCode = this.authTotp.value;

				const response = await fetch(`${this.baseUrl}/api/auth/v2/auth?op=verify2fa&mode=strict&sec=2`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						totpCode,
						verificationToken: this.verificationToken
					})
				});

				const result = await response.json();

				if (result.protocol === 'SXAP') {
					this.token = result.sxap_token;
					this.user = result.user;
					this.saveSession();
					this.updateUI();
					this.hideAuthModal();
					this.showAuthMessage('2FA verification successful!', 'success');
				} else {
					throw new Error(result.message || '2FA verification failed');
				}
			}

			async showDashboard() {
				if (!this.token) {
					this.showAuthModal(true);
					return;
				}

				try {
					// Copy background content
					const backgroundContent = document.querySelector('.dashboard-modal .modal-background-content');
					const mainContent = document.querySelector('.container');
					if (backgroundContent && mainContent) {
						backgroundContent.innerHTML = mainContent.outerHTML;
					}

					// Update username in dashboard
					const usernameSpan = document.getElementById('dashboardUsername');
					if (usernameSpan && this.user) {
						usernameSpan.textContent = this.user.username || 'User';
					}

					// Load user stats only
					await this.loadUserStats();

					this.dashboardModal.classList.add('show');
				} catch (error) {
					console.error('Dashboard error:', error);
					this.showAuthError('Failed to load dashboard');
				}
			}

			hideDashboard() {
				this.dashboardModal.classList.remove('show');
			}

			async showFileViewer() {
				if (!this.token) {
					this.showAuthModal(true);
					return;
				}

				try {
					await this.loadFileViewerData();
					this.fileViewerPanel.classList.add('show');
				} catch (error) {
					console.error('File viewer error:', error);
					this.showAuthError('Failed to load files');
				}
			}

			hideFileViewer() {
				this.fileViewerPanel.classList.remove('show');
			}

			async refreshFileViewer() {
				if (this.fileViewerPanel.classList.contains('show')) {
					await this.loadFileViewerData();
				}
			}

			async loadFileViewerData() {
				const response = await fetch(`${this.baseUrl}/api/user/uploads?limit=50`, {
					headers: { 'Authorization': `Bearer ${this.token}` }
				});

				if (!response.ok) throw new Error('Failed to load user files');

				const result = await response.json();
				const uploads = result.uploads || [];

				// Update stats
				const totalSize = uploads.reduce((sum, upload) => sum + (upload.size || upload.fileSize || 0), 0);
				this.fileStatCount.textContent = uploads.length;
				this.fileStatSize.textContent = this.formatFileSize(totalSize);

				// Render file list
				if (uploads.length === 0) {
					this.fileViewerList.innerHTML = `
						<div class="file-viewer-empty">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
							</svg>
							<h4>No files yet</h4>
							<p>Upload your first file to get started</p>
						</div>
					`;
				} else {
					this.fileViewerList.innerHTML = uploads.map(upload => {
						const fileName = upload.name || upload.originalName || 'Unnamed';
						const fileSize = this.formatFileSize(upload.size || upload.fileSize || 0);
						const uploadDate = new Date(upload.createdAt || upload.uploadedAt).toLocaleDateString();
						const fileId = upload.id || upload.path || upload.filePath;
						const filePath = upload.path || upload.filePath;

						return `
							<div class="file-item" onclick="window.open('${filePath}', '_blank')">
								<div class="file-item-icon">
									${this.getFileIcon(fileName)}
								</div>
								<div class="file-item-content">
									<div class="file-item-name" title="${fileName}">${fileName}</div>
									<div class="file-item-meta">
										<span class="file-item-size">${fileSize}</span>
										<span>•</span>
										<span>${uploadDate}</span>
									</div>
								</div>
								<div class="file-item-actions">
									<button class="file-action-btn" onclick="event.stopPropagation(); cdnApp.fileEditor.selectFileById('${fileId}')" title="Edit file">
										<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
											<polyline points="14,2 14,8 20,8"/>
										</svg>
									</button>
									<button class="file-action-btn" onclick="event.stopPropagation(); cdnApp.auth.showFileInfo('${fileId}')" title="File info">
										<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
										</svg>
									</button>
									<button class="file-action-btn danger" onclick="event.stopPropagation(); cdnApp.auth.deleteFile('${fileId}', '${fileName}')" title="Delete">
										<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
										</svg>
									</button>
								</div>
							</div>
						`;
					}).join('');
				}
			}

			getFileIcon(fileName) {
				const ext = fileName.split('.').pop().toLowerCase();

				if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(ext)) {
					return `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
						<circle cx="8.5" cy="8.5" r="1.5"/>
						<polyline points="21,15 16,10 5,21"/>
					</svg>`;
				} else if (['mp4', 'avi', 'mov', 'wmv'].includes(ext)) {
					return `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<polygon points="23 7 16 12 23 17 23 7"/>
						<rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
					</svg>`;
				} else if (['mp3', 'wav', 'ogg', 'flac'].includes(ext)) {
					return `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path d="M9 18V5l12-2v13"/>
						<circle cx="6" cy="18" r="3"/>
						<circle cx="18" cy="16" r="3"/>
					</svg>`;
				} else if (['pdf'].includes(ext)) {
					return `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
					</svg>`;
				} else {
					return `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
					</svg>`;
				}
			}

			async loadUserStats() {
				const response = await fetch(`${this.baseUrl}/api/user/quota`, {
					headers: { 'Authorization': `Bearer ${this.token}` }
				});

				if (!response.ok) throw new Error('Failed to load user stats');

				const result = await response.json();
				const quota = result.quota;

				this.dashboardStats.innerHTML = `
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Storage Used</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
							</svg>
						</div>
						<div class="stat-value">${this.formatFileSize(quota.usage?.storageBreakdown?.total || quota.currentStorage || 0)}</div>
						<div class="stat-description">of ${quota.limits?.maxStorage > 0 ? this.formatFileSize(quota.limits.maxStorage) : 'unlimited'} used</div>
						${quota.limits?.maxStorage > 0 ? this.renderStorageVisualization(quota.storageVisualization) : ''}
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Files</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
							</svg>
						</div>
						<div class="stat-value">${quota.usage?.files || quota.currentFiles || 0}</div>
						<div class="stat-description">files uploaded</div>
						${quota.limits?.maxFiles > 0 ? `<div class="quota-bar"><div class="quota-fill ${quota.percentage?.files > 90 ? 'warning' : 'success'}" style="width: ${Math.min(quota.percentage?.files || 0, 100)}%"></div></div>` : ''}
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Storage Limit</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
							</svg>
						</div>
						<div class="stat-value">${quota.limits?.maxStorage > 0 ? this.formatFileSize(quota.limits.maxStorage) : '∞'}</div>
						<div class="stat-description">total available</div>
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Account Type</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
							</svg>
						</div>
						<div class="stat-value" style="font-size: 1.25rem; text-transform: capitalize;">${this.user?.role || 'user'}</div>
						<div class="stat-description">membership level</div>
					</div>
				`;
			}



			formatFileSize(bytes) {
				if (bytes === 0) return '0 B';
				const k = 1024;
				const sizes = ['B', 'KB', 'MB', 'GB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
			}

			renderStorageVisualization(visualization) {
				if (!visualization) return '';

				const { fileStorage, versionStorage, totalUsed, available } = visualization;

				return `
					<div class="storage-visualization">
						<div class="storage-breakdown">
							<div class="storage-breakdown-item">
								<div class="storage-label" style="color: ${fileStorage.color};">
									<div class="storage-color-dot" style="background-color: ${fileStorage.color};"></div>
									${fileStorage.label}
								</div>
								<div class="storage-amount">${this.formatFileSize(fileStorage.bytes)}</div>
							</div>
							<div class="storage-breakdown-item">
								<div class="storage-label" style="color: ${versionStorage.color};">
									<div class="storage-color-dot" style="background-color: ${versionStorage.color};"></div>
									${versionStorage.label}
								</div>
								<div class="storage-amount">${this.formatFileSize(versionStorage.bytes)}</div>
							</div>
						</div>
						<div class="storage-bar">
							<div class="storage-segment"
								 style="width: ${fileStorage.percentage}%; background-color: ${fileStorage.color};"
								 title="${fileStorage.label}: ${this.formatFileSize(fileStorage.bytes)}"></div>
							<div class="storage-segment"
								 style="width: ${versionStorage.percentage}%; background-color: ${versionStorage.color};"
								 title="${versionStorage.label}: ${this.formatFileSize(versionStorage.bytes)}"></div>
						</div>
						<div class="storage-summary">
							<span class="storage-used">${this.formatFileSize(totalUsed.bytes)} used</span>
							<span class="storage-available">${this.formatFileSize(available.bytes)} available</span>
						</div>
					</div>
				`;
			}

			logout() {
				this.token = null;
				this.user = null;
				this.clearSession();
				this.updateUI();
				this.showAuthMessage('Logged out successfully', 'success');
			}

			updateUI() {
				if (this.token && this.user) {
					this.authLoggedOut.style.display = 'none';
					this.authLoggedIn.style.display = 'block';
					this.usernameEl.textContent = this.user.username;
					this.userRoleEl.textContent = this.user.role || 'user';

					// Set user initials
					const initials = this.user.username.substring(0, 2).toUpperCase();
					this.userInitialsEl.textContent = initials;
				} else {
					this.authLoggedOut.style.display = 'block';
					this.authLoggedIn.style.display = 'none';
				}
			}

			saveSession() {
				if (this.token && this.user) {
					localStorage.setItem('sxap_session', JSON.stringify({
						token: this.token,
						user: this.user,
						timestamp: Date.now()
					}));
				}
			}

			loadSession() {
				try {
					const session = localStorage.getItem('sxap_session');
					if (session) {
						const data = JSON.parse(session);
						// Check if session is less than 24 hours old
						if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
							this.token = data.token;
							this.user = data.user;
							return true;
						} else {
							this.clearSession();
						}
					}
				} catch (error) {
					console.error('Failed to load session:', error);
					this.clearSession();
				}
				return false;
			}

			clearSession() {
				localStorage.removeItem('sxap_session');
			}

			showAuthMessage(message, type = 'error') {
				this.authMessage.innerHTML = `<div class="auth-${type}">${message}</div>`;
			}

			showAuthError(message) {
				this.showAuthMessage(message, 'error');
			}

			// Get authorization header for API requests
			getAuthHeader() {
				return this.token ? { 'Authorization': `Bearer ${this.token}` } : {};
			}

			// Check if user is authenticated
			isAuthenticated() {
				return !!this.token;
			}

			// Show file information modal
			async showFileInfo(fileId) {
				if (!this.token) {
					this.showAuthModal(true);
					return;
				}

				try {
					const response = await fetch(`${this.baseUrl}/api/files/${fileId}`, {
						headers: { 'Authorization': `Bearer ${this.token}` }
					});

					if (!response.ok) {
						if (response.status === 401) {
							this.showAuthModal(true);
							return;
						}
						throw new Error('Failed to load file information');
					}

					const result = await response.json();
					const file = result.file;

					// Create and show file info modal
					const modal = document.createElement('div');
					modal.className = 'file-info-modal';
					modal.innerHTML = `
						<div class="modal-backdrop"></div>
						<div class="modal-content">
							<div class="modal-header">
								<h3>File Information</h3>
								<button class="modal-close" onclick="this.closest('.file-info-modal').remove()">
									<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<line x1="18" y1="6" x2="6" y2="18"/>
										<line x1="6" y1="6" x2="18" y2="18"/>
									</svg>
								</button>
							</div>
							<div class="modal-body">
								<div class="file-details">
									<div class="detail-row">
										<span class="detail-label">Name:</span>
										<span class="detail-value">${file.name}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Original Name:</span>
										<span class="detail-value">${file.originalName}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Path:</span>
										<span class="detail-value" style="font-family: monospace; word-break: break-all;">${file.path}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Size:</span>
										<span class="detail-value">${this.formatFileSize(file.size)}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Type:</span>
										<span class="detail-value">${file.mimeType}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Upload Type:</span>
										<span class="detail-value">${file.type}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Uploaded:</span>
										<span class="detail-value">${new Date(file.uploadedAt).toLocaleString()}</span>
									</div>
									${file.category ? `
									<div class="detail-row">
										<span class="detail-label">Category:</span>
										<span class="detail-value">${file.category}</span>
									</div>
									` : ''}
									${file.description ? `
									<div class="detail-row">
										<span class="detail-label">Description:</span>
										<span class="detail-value">${file.description}</span>
									</div>
									` : ''}
									${file.tags && file.tags.length > 0 ? `
									<div class="detail-row">
										<span class="detail-label">Tags:</span>
										<span class="detail-value">${file.tags.join(', ')}</span>
									</div>
									` : ''}
								</div>
								<div class="file-actions">
									<button onclick="window.open('${file.path}', '_blank')" class="btn btn-primary">View File</button>
									<button onclick="navigator.clipboard.writeText('${window.location.origin}${file.path}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy URL', 2000)" class="btn btn-secondary">Copy URL</button>
								</div>
							</div>
						</div>
					`;

					document.body.appendChild(modal);
					modal.classList.add('show');

					// Close on backdrop click
					modal.querySelector('.modal-backdrop').addEventListener('click', () => {
						modal.remove();
					});

				} catch (error) {
					console.error('File info error:', error);
					alert('Failed to load file information: ' + error.message);
				}
			}

			// Delete file
			async deleteFile(fileId, fileName) {
				if (!this.token) {
					this.showAuthModal(true);
					return;
				}

				if (!confirm(`Are you sure you want to delete "${fileName}"? This action cannot be undone.`)) {
					return;
				}

				try {
					const response = await fetch(`${this.baseUrl}/api/files/${fileId}`, {
						method: 'DELETE',
						headers: { 'Authorization': `Bearer ${this.token}` }
					});

					if (!response.ok) {
						if (response.status === 401) {
							this.showAuthModal(true);
							return;
						}
						throw new Error('Failed to delete file');
					}

					const result = await response.json();

					// Show success message
					this.showAuthMessage(`File "${fileName}" deleted successfully`, 'success');

					// Refresh file viewer if open
					if (this.fileViewerPanel.classList.contains('show')) {
						await this.loadFileViewerData();
					}

					// Refresh dashboard if open
					if (this.dashboardModal.classList.contains('show')) {
						await this.loadUserStats(); // Refresh quota info
					}

				} catch (error) {
					console.error('Delete file error:', error);
					alert('Failed to delete file: ' + error.message);
				}
			}
		}

		// Status Modal Class
		class StatusModal {
			constructor() {
				this.modal = document.getElementById('statusModal');
				this.closeBtn = document.getElementById('statusClose');
				this.systemStats = document.getElementById('systemStats');
				this.networkMap = document.getElementById('networkMap');

				this.setupEventListeners();
			}

			setupEventListeners() {
				this.closeBtn.addEventListener('click', () => this.hide());
				this.modal.addEventListener('click', (e) => {
					if (e.target === this.modal) this.hide();
				});
			}

			async show() {
				// Copy background content
				const backgroundContent = document.querySelector('#statusModal .modal-background-content');
				const mainContent = document.querySelector('.container');
				if (backgroundContent && mainContent) {
					backgroundContent.innerHTML = mainContent.outerHTML;
				}

				await this.loadSystemStats();
				this.renderNetworkMap();
				this.modal.classList.add('show');
			}

			hide() {
				this.modal.classList.remove('show');
			}

			async loadSystemStats() {
				try {
					const [healthResponse, traceResponse] = await Promise.all([
						fetch('/api/health'),
						fetch('/cdn-cgi/trace')
					]);

					const healthData = await healthResponse.json();
					const traceText = await traceResponse.text();
					const traceData = this.parseTraceData(traceText);

					this.renderSystemStats(healthData, traceData);
				} catch (error) {
					console.error('Failed to load system stats:', error);
					this.systemStats.innerHTML = '<div class="empty-state"><div class="empty-state-title">Unable to load system stats</div></div>';
				}
			}

			parseTraceData(traceText) {
				const data = {};
				const lines = traceText.trim().split('\n');

				lines.forEach(line => {
					const [key, value] = line.split('=');
					if (key && value) {
						data[key] = value;
					}
				});

				return data;
			}

			getLocationName(colo) {
				const locations = {
					'FRA': 'Frankfurt, Germany',
					'LHR': 'London, UK',
					'CDG': 'Paris, France',
					'AMS': 'Amsterdam, Netherlands',
					'SJC': 'San Jose, CA',
					'LAX': 'Los Angeles, CA',
					'DFW': 'Dallas, TX',
					'ORD': 'Chicago, IL',
					'ATL': 'Atlanta, GA',
					'IAD': 'Washington, DC',
					'NRT': 'Tokyo, Japan',
					'HKG': 'Hong Kong',
					'SIN': 'Singapore',
					'SYD': 'Sydney, Australia',
					'GRU': 'São Paulo, Brazil',
					'YYZ': 'Toronto, Canada',
					'BOM': 'Mumbai, India'
				};
				return locations[colo] || colo;
			}

			getCountryFlag(loc) {
				const flags = {
					'DE': '🇩🇪', 'GB': '🇬🇧', 'FR': '🇫🇷', 'NL': '🇳🇱',
					'US': '🇺🇸', 'JP': '🇯🇵', 'HK': '🇭🇰', 'SG': '🇸🇬',
					'AU': '🇦🇺', 'BR': '🇧🇷', 'CA': '🇨🇦', 'IN': '🇮🇳'
				};
				return flags[loc] || '🌐';
			}

			renderSystemStats(healthData, traceData) {
				const coloLocation = this.getLocationName(traceData.colo);
				const countryFlag = this.getCountryFlag(traceData.loc);
				const timestamp = traceData.ts ? new Date(parseFloat(traceData.ts) * 1000).toLocaleString() : 'Unknown';

				this.systemStats.innerHTML = `
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">System Status</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
							</svg>
						</div>
						<div class="stat-value" style="color: hsl(142, 76%, 36%);">Operational</div>
						<div class="stat-description">All systems running normally</div>
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Your Location</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
							</svg>
						</div>
						<div class="stat-value">${countryFlag} ${traceData.ip || 'Unknown'}</div>
						<div class="stat-description">${coloLocation}</div>
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Edge Server</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
							</svg>
						</div>
						<div class="stat-value">${traceData.colo || 'Unknown'}</div>
						<div class="stat-description">Cloudflare datacenter</div>
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Protocol</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
							</svg>
						</div>
						<div class="stat-value">${traceData.tls || 'Unknown'}</div>
						<div class="stat-description">${traceData.http || 'HTTP/1.1'}</div>
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Connection</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
							</svg>
						</div>
						<div class="stat-value">${traceData.visit_scheme?.toUpperCase() || 'HTTPS'}</div>
						<div class="stat-description">Secure connection</div>
					</div>
					<div class="stat-card">
						<div class="stat-header">
							<span class="stat-title">Request Time</span>
							<svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
							</svg>
						</div>
						<div class="stat-value">${healthData.responseTime || '< 100'}ms</div>
						<div class="stat-description">${timestamp}</div>
					</div>
					<div class="trace-details">
						<div class="trace-header">
							<span class="trace-title">CDN Trace Details</span>
							<button class="trace-refresh-btn" onclick="window.statusModal.loadSystemStats()">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M23 4v6h-6"/>
									<path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
								</svg>
								Refresh
							</button>
						</div>
						<div class="trace-grid">
							${Object.entries(traceData).map(([key, value]) => `
								<div class="trace-item">
									<div class="trace-key">${key}</div>
									<div class="trace-value">${value}</div>
								</div>
							`).join('')}
						</div>
					</div>
				`;
			}

			renderNetworkMap() {
				const locations = [
					{ name: 'San Francisco', lat: 37.7749, lng: -122.4194, status: 'online' },
					{ name: 'New York', lat: 40.7128, lng: -74.0060, status: 'online' },
					{ name: 'London', lat: 51.5074, lng: -0.1278, status: 'online' },
					{ name: 'Tokyo', lat: 35.6762, lng: 139.6503, status: 'online' },
					{ name: 'Sydney', lat: -33.8688, lng: 151.2093, status: 'online' },
					{ name: 'Frankfurt', lat: 50.1109, lng: 8.6821, status: 'online' },
					{ name: 'Singapore', lat: 1.3521, lng: 103.8198, status: 'online' },
					{ name: 'São Paulo', lat: -23.5505, lng: -46.6333, status: 'online' },
					{ name: 'Mumbai', lat: 19.0760, lng: 72.8777, status: 'online' },
					{ name: 'Toronto', lat: 43.6532, lng: -79.3832, status: 'online' }
				];

				// Create world map SVG background
				const worldMapSVG = `
					<svg class="world-map-svg" viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
						<!-- World map continents -->
						<!-- North America -->
						<path d="M 50,80 C 50,70 60,60 80,55 C 120,50 160,55 180,70 C 200,85 210,110 215,130 C 220,150 215,170 200,180 C 180,190 160,185 140,180 C 120,175 100,165 85,150 C 70,135 55,120 50,100 Z" />
						<!-- South America -->
						<path d="M 120,200 C 130,190 140,185 150,190 C 160,195 165,210 170,230 C 175,250 180,270 175,290 C 170,310 160,325 145,330 C 130,335 115,330 105,315 C 95,300 100,280 105,260 C 110,240 115,220 120,200 Z" />
						<!-- Europe -->
						<path d="M 280,70 C 290,65 310,60 330,65 C 350,70 365,80 375,95 C 385,110 380,125 370,135 C 360,145 345,150 330,145 C 315,140 305,130 295,115 C 285,100 280,85 280,70 Z" />
						<!-- Africa -->
						<path d="M 300,140 C 315,135 330,140 340,155 C 350,170 355,190 360,210 C 365,230 370,250 365,270 C 360,290 350,305 335,310 C 320,315 305,310 295,295 C 285,280 290,260 295,240 C 300,220 300,200 305,180 C 305,160 300,150 300,140 Z" />
						<!-- Asia -->
						<path d="M 400,60 C 430,55 460,60 490,70 C 520,80 545,95 570,115 C 595,135 615,160 625,185 C 635,210 630,235 615,250 C 600,265 580,270 560,265 C 540,260 525,245 515,225 C 505,205 500,180 495,155 C 490,130 485,105 475,85 C 465,65 450,55 430,55 C 415,55 405,60 400,60 Z" />
						<!-- Australia -->
						<path d="M 580,280 C 595,275 610,280 620,295 C 630,310 625,325 615,335 C 605,345 590,350 575,345 C 560,340 550,325 555,310 C 560,295 570,285 580,280 Z" />
						<!-- Antarctica -->
						<path d="M 100,350 C 200,345 300,345 400,350 C 500,355 600,360 700,365 C 650,375 550,380 450,375 C 350,370 250,365 150,360 C 125,358 112,354 100,350 Z" />
					</svg>
				`;

				this.networkMap.innerHTML = worldMapSVG + locations.map(location => {
					const x = ((location.lng + 180) / 360) * 100;
					const y = ((90 - location.lat) / 180) * 100;

					return `
						<div class="network-point ${location.status}"
							 style="left: ${x}%; top: ${y}%;"
							 data-location="${location.name}">
						</div>
						<div class="network-tooltip" style="left: ${x}%; top: ${y - 10}%;">
							<strong>${location.name}</strong><br>
							Status: ${location.status}<br>
							Latency: ${Math.floor(Math.random() * 50 + 10)}ms
						</div>
					`;
				}).join('');
			}
		}

		// API Modal Class
		class APIModal {
			constructor() {
				this.modal = document.getElementById('apiModal');
				this.closeBtn = document.getElementById('apiClose');
				this.apiSections = document.getElementById('apiSections');

				this.setupEventListeners();
			}

			setupEventListeners() {
				this.closeBtn.addEventListener('click', () => this.hide());
				this.modal.addEventListener('click', (e) => {
					if (e.target === this.modal) this.hide();
				});
			}

			show() {
				// Copy background content
				const backgroundContent = document.querySelector('#apiModal .modal-background-content');
				const mainContent = document.querySelector('.container');
				if (backgroundContent && mainContent) {
					backgroundContent.innerHTML = mainContent.outerHTML;
				}

				this.renderAPIDocumentation();
				this.modal.classList.add('show');
			}

			hide() {
				this.modal.classList.remove('show');
			}

			renderAPIDocumentation() {
				const apiSections = [
					{
						title: 'Authentication',
						description: 'SXAP authentication endpoints for user management',
						endpoints: [
							{ method: 'POST', path: '/api/auth/v2/auth', description: 'Authenticate user with username/password' },
							{ method: 'POST', path: '/api/auth/v2/register', description: 'Register new user account' },
							{ method: 'POST', path: '/api/auth/v2/2fa', description: 'Verify 2FA token' },
							{ method: 'POST', path: '/api/auth/v2/logout', description: 'Logout and invalidate session' }
						]
					},
					{
						title: 'File Management',
						description: 'Upload, manage, and retrieve files from the CDN with authentication',
						endpoints: [
							{ method: 'POST', path: '/api/upload/direct', description: 'Upload file directly to CDN with obfuscation' },
							{ method: 'POST', path: '/api/upload/database', description: 'Upload file with metadata to database' },
							{ method: 'GET', path: '/api/files/:id', description: 'Get detailed file information (auth required)' },
							{ method: 'PUT', path: '/api/files/:id', description: 'Update file metadata (auth required)' },
							{ method: 'DELETE', path: '/api/files/:id', description: 'Delete file from CDN (auth required)' },
							{ method: 'GET', path: '/api/user/uploads', description: 'List user uploads with pagination' }
						]
					},
					{
						title: 'User Management',
						description: 'User profile and quota management endpoints',
						endpoints: [
							{ method: 'GET', path: '/api/user/profile', description: 'Get user profile information' },
							{ method: 'GET', path: '/api/user/quota', description: 'Get user quota and usage' },
							{ method: 'PUT', path: '/api/user/profile', description: 'Update user profile' }
						]
					},
					{
						title: 'System',
						description: 'System status and health check endpoints',
						endpoints: [
							{ method: 'GET', path: '/api/health', description: 'System health check' },
							{ method: 'GET', path: '/api/workers', description: 'Worker status information' },
							{ method: 'GET', path: '/api/stats', description: 'System statistics' }
						]
					}
				];

				this.apiSections.innerHTML = apiSections.map(section => `
					<div class="api-section">
						<div class="api-section-header">
							<div class="api-section-title">${section.title}</div>
							<div class="api-section-description">${section.description}</div>
						</div>
						<div class="api-endpoints">
							${section.endpoints.map(endpoint => `
								<div class="api-endpoint">
									<div class="api-endpoint-info">
										<div class="api-method ${endpoint.method.toLowerCase()}">${endpoint.method}</div>
										<div class="api-endpoint-details">
											<div class="api-endpoint-path">${endpoint.path}</div>
											<div class="api-endpoint-description">${endpoint.description}</div>
										</div>
									</div>
									<div class="api-endpoint-actions">
										<button class="api-try-btn" onclick="window.open('${endpoint.path}', '_blank')">Try</button>
										<button class="api-copy-btn" onclick="navigator.clipboard.writeText('${window.location.origin}${endpoint.path}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000)">Copy</button>
									</div>
								</div>
							`).join('')}
						</div>
					</div>
				`).join('');
			}
			// Advanced Editor Methods

		}

		// Dev Tools Modal Class
		class DevToolsModal {
			constructor() {
				this.modal = document.getElementById('devToolsModal');
				this.closeBtn = document.getElementById('devToolsClose');
				this.devToolsSections = document.getElementById('devToolsSections');
				this.consoleHistory = [];
				this.consoleIndex = -1;

				this.setupEventListeners();
			}

			setupEventListeners() {
				this.closeBtn.addEventListener('click', () => this.hide());
				this.modal.addEventListener('click', (e) => {
					if (e.target === this.modal) this.hide();
				});
			}

			async show() {
				// Copy background content
				const backgroundContent = document.querySelector('#devToolsModal .modal-background-content');
				const mainContent = document.querySelector('.container');
				if (backgroundContent && mainContent) {
					backgroundContent.innerHTML = mainContent.outerHTML;
				}

				this.renderDevToolsInterface();
				this.modal.classList.add('show');
			}

			hide() {
				this.modal.classList.remove('show');
			}

			renderDevToolsInterface() {
				this.devToolsSections.innerHTML = `
					<div class="devtools-section">
						<div class="devtools-section-header">
							<div class="devtools-section-title">Console</div>
							<div class="devtools-tabs">
								<button class="devtools-tab active" onclick="window.devToolsModal.switchTab('console')">Console</button>
								<button class="devtools-tab" onclick="window.devToolsModal.switchTab('network')">Network</button>
								<button class="devtools-tab" onclick="window.devToolsModal.switchTab('performance')">Performance</button>
								<button class="devtools-tab" onclick="window.devToolsModal.switchTab('storage')">Storage</button>
							</div>
						</div>
						<div class="devtools-content">
							<div id="devtools-console" class="devtools-panel active">
								<div class="console-output" id="consoleOutput">
									<div class="console-line console-info">
										<span class="console-timestamp">${new Date().toLocaleTimeString()}</span>
										<span class="console-message">Welcome to JWLimited CDN Developer Console</span>
									</div>
									<div class="console-line console-info">
										<span class="console-timestamp">${new Date().toLocaleTimeString()}</span>
										<span class="console-message">Type 'help' for available commands</span>
									</div>
								</div>
								<div class="console-input-container">
									<span class="console-prompt">></span>
									<input type="text" class="console-input" id="consoleInput" placeholder="Enter JavaScript or CDN commands..." />
								</div>
							</div>
							<div id="devtools-network" class="devtools-panel">
								<div class="network-requests" id="networkRequests">
									<div class="network-header">
										<div class="network-col">Name</div>
										<div class="network-col">Status</div>
										<div class="network-col">Type</div>
										<div class="network-col">Size</div>
										<div class="network-col">Time</div>
									</div>
									<div id="networkRequestsList"></div>
								</div>
							</div>
							<div id="devtools-performance" class="devtools-panel">
								<div class="performance-metrics" id="performanceMetrics">
									<!-- Performance metrics will be loaded here -->
								</div>
							</div>
							<div id="devtools-storage" class="devtools-panel">
								<div class="storage-sections" id="storageSections">
									<!-- Storage data will be loaded here -->
								</div>
							</div>
						</div>
					</div>
				`;

				this.setupConsole();
				this.loadNetworkRequests();
				this.loadPerformanceMetrics();
				this.loadStorageData();
			}

			setupConsole() {
				const consoleInput = document.getElementById('consoleInput');
				const consoleOutput = document.getElementById('consoleOutput');

				consoleInput.addEventListener('keydown', (e) => {
					if (e.key === 'Enter') {
						const command = consoleInput.value.trim();
						if (command) {
							this.executeCommand(command);
							this.consoleHistory.push(command);
							this.consoleIndex = this.consoleHistory.length;
							consoleInput.value = '';
						}
					} else if (e.key === 'ArrowUp') {
						e.preventDefault();
						if (this.consoleIndex > 0) {
							this.consoleIndex--;
							consoleInput.value = this.consoleHistory[this.consoleIndex];
						}
					} else if (e.key === 'ArrowDown') {
						e.preventDefault();
						if (this.consoleIndex < this.consoleHistory.length - 1) {
							this.consoleIndex++;
							consoleInput.value = this.consoleHistory[this.consoleIndex];
						} else {
							this.consoleIndex = this.consoleHistory.length;
							consoleInput.value = '';
						}
					}
				});

				// Intercept console methods
				this.originalConsole = {
					log: console.log,
					error: console.error,
					warn: console.warn,
					info: console.info
				};

				const self = this;
				console.log = function(...args) {
					self.originalConsole.log.apply(console, args);
					self.addConsoleMessage('log', args.join(' '));
				};
				console.error = function(...args) {
					self.originalConsole.error.apply(console, args);
					self.addConsoleMessage('error', args.join(' '));
				};
				console.warn = function(...args) {
					self.originalConsole.warn.apply(console, args);
					self.addConsoleMessage('warn', args.join(' '));
				};
				console.info = function(...args) {
					self.originalConsole.info.apply(console, args);
					self.addConsoleMessage('info', args.join(' '));
				};
			}

			executeCommand(command) {
				this.addConsoleMessage('command', `> ${command}`);

				try {
					// CDN-specific commands
					if (command.startsWith('cdn.')) {
						this.executeCDNCommand(command);
					} else if (command === 'help') {
						this.showHelp();
					} else if (command === 'clear') {
						document.getElementById('consoleOutput').innerHTML = '';
					} else if (command.startsWith('fetch ')) {
						this.executeFetchCommand(command.substring(6));
					} else {
						// Execute JavaScript
						const result = eval(command);
						this.addConsoleMessage('result', result);
					}
				} catch (error) {
					this.addConsoleMessage('error', error.message);
				}
			}

			executeCDNCommand(command) {
				const parts = command.split('.');
				const method = parts[1];

				switch (method) {
					case 'status':
						fetch('/api/health')
							.then(r => r.json())
							.then(data => this.addConsoleMessage('result', JSON.stringify(data, null, 2)));
						break;
					case 'uploads':
						if (window.assetSearch?.auth?.isAuthenticated()) {
							fetch('/api/user/uploads', {
								headers: window.assetSearch.auth.getAuthHeader()
							})
							.then(r => r.json())
							.then(data => this.addConsoleMessage('result', JSON.stringify(data, null, 2)));
						} else {
							this.addConsoleMessage('error', 'Authentication required');
						}
						break;
					case 'quota':
						if (window.assetSearch?.auth?.isAuthenticated()) {
							fetch('/api/user/quota', {
								headers: window.assetSearch.auth.getAuthHeader()
							})
							.then(r => r.json())
							.then(data => this.addConsoleMessage('result', JSON.stringify(data, null, 2)));
						} else {
							this.addConsoleMessage('error', 'Authentication required');
						}
						break;
					default:
						this.addConsoleMessage('error', `Unknown CDN command: ${method}`);
				}
			}

			executeFetchCommand(url) {
				fetch(url)
					.then(response => {
						this.addConsoleMessage('info', `Response: ${response.status} ${response.statusText}`);
						return response.text();
					})
					.then(data => {
						try {
							const json = JSON.parse(data);
							this.addConsoleMessage('result', JSON.stringify(json, null, 2));
						} catch {
							this.addConsoleMessage('result', data);
						}
					})
					.catch(error => this.addConsoleMessage('error', error.message));
			}

			showHelp() {
				const helpText = `
Available Commands:
• help - Show this help message
• clear - Clear console output
• fetch <url> - Fetch data from URL
• cdn.status - Get CDN system status
• cdn.uploads - Get user uploads (requires auth)
• cdn.quota - Get user quota (requires auth)
• JavaScript expressions - Execute JavaScript code
				`;
				this.addConsoleMessage('info', helpText);
			}

			addConsoleMessage(type, message) {
				const consoleOutput = document.getElementById('consoleOutput');
				const timestamp = new Date().toLocaleTimeString();
				const line = document.createElement('div');
				line.className = `console-line console-${type}`;
				line.innerHTML = `
					<span class="console-timestamp">${timestamp}</span>
					<span class="console-message">${this.escapeHtml(message)}</span>
				`;
				consoleOutput.appendChild(line);
				consoleOutput.scrollTop = consoleOutput.scrollHeight;
			}

			escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			switchTab(tabName) {
				// Update tab buttons
				document.querySelectorAll('.devtools-tab').forEach(tab => {
					tab.classList.remove('active');
				});
				event.target.classList.add('active');

				// Update panels
				document.querySelectorAll('.devtools-panel').forEach(panel => {
					panel.classList.remove('active');
				});
				document.getElementById(`devtools-${tabName}`).classList.add('active');
			}

			loadNetworkRequests() {
				// Monitor network requests
				const requestsList = document.getElementById('networkRequestsList');

				// Override fetch to monitor requests
				const originalFetch = window.fetch;
				window.fetch = async function(...args) {
					const startTime = performance.now();
					const url = args[0];

					try {
						const response = await originalFetch.apply(this, args);
						const endTime = performance.now();
						const duration = Math.round(endTime - startTime);

						// Add to network panel
						const requestRow = document.createElement('div');
						requestRow.className = 'network-row';
						requestRow.innerHTML = `
							<div class="network-col">${url}</div>
							<div class="network-col network-status-${Math.floor(response.status / 100)}">${response.status}</div>
							<div class="network-col">${response.headers.get('content-type') || 'unknown'}</div>
							<div class="network-col">${response.headers.get('content-length') || 'unknown'}</div>
							<div class="network-col">${duration}ms</div>
						`;
						if (requestsList) requestsList.appendChild(requestRow);

						return response;
					} catch (error) {
						const endTime = performance.now();
						const duration = Math.round(endTime - startTime);

						const requestRow = document.createElement('div');
						requestRow.className = 'network-row';
						requestRow.innerHTML = `
							<div class="network-col">${url}</div>
							<div class="network-col network-status-error">Error</div>
							<div class="network-col">-</div>
							<div class="network-col">-</div>
							<div class="network-col">${duration}ms</div>
						`;
						if (requestsList) requestsList.appendChild(requestRow);

						throw error;
					}
				};
			}

			loadPerformanceMetrics() {
				const metrics = {
					'Memory Usage': `${(performance.memory?.usedJSHeapSize / 1024 / 1024).toFixed(2) || 'N/A'} MB`,
					'Total Memory': `${(performance.memory?.totalJSHeapSize / 1024 / 1024).toFixed(2) || 'N/A'} MB`,
					'Memory Limit': `${(performance.memory?.jsHeapSizeLimit / 1024 / 1024).toFixed(2) || 'N/A'} MB`,
					'Load Time': `${(performance.timing?.loadEventEnd - performance.timing?.navigationStart || 0)}ms`,
					'DOM Ready': `${(performance.timing?.domContentLoadedEventEnd - performance.timing?.navigationStart || 0)}ms`,
					'DOM Nodes': document.querySelectorAll('*').length,
					'Scripts': document.querySelectorAll('script').length,
					'Stylesheets': document.querySelectorAll('link[rel="stylesheet"], style').length
				};

				const metricsContainer = document.getElementById('performanceMetrics');
				if (metricsContainer) {
					metricsContainer.innerHTML = `
						<div class="devtools-grid">
							${Object.entries(metrics).map(([key, value]) => `
								<div class="devtools-metric">
									<div class="devtools-metric-title">${key}</div>
									<div class="devtools-metric-value">${value}</div>
								</div>
							`).join('')}
						</div>
					`;
				}
			}

			loadStorageData() {
				const storageContainer = document.getElementById('storageSections');

				const localStorageData = Object.keys(localStorage).map(key => ({
					key,
					value: localStorage.getItem(key),
					size: new Blob([localStorage.getItem(key)]).size
				}));

				const sessionStorageData = Object.keys(sessionStorage).map(key => ({
					key,
					value: sessionStorage.getItem(key),
					size: new Blob([sessionStorage.getItem(key)]).size
				}));

				storageContainer.innerHTML = `
					<div class="storage-section">
						<h3>Local Storage</h3>
						<div class="storage-table">
							<div class="storage-header">
								<div>Key</div>
								<div>Value</div>
								<div>Size</div>
							</div>
							${localStorageData.map(item => `
								<div class="storage-row">
									<div class="storage-key">${item.key}</div>
									<div class="storage-value">${item.value.substring(0, 100)}${item.value.length > 100 ? '...' : ''}</div>
									<div class="storage-size">${item.size} bytes</div>
								</div>
							`).join('')}
						</div>
					</div>
					<div class="storage-section">
						<h3>Session Storage</h3>
						<div class="storage-table">
							<div class="storage-header">
								<div>Key</div>
								<div>Value</div>
								<div>Size</div>
							</div>
							${sessionStorageData.map(item => `
								<div class="storage-row">
									<div class="storage-key">${item.key}</div>
									<div class="storage-value">${item.value.substring(0, 100)}${item.value.length > 100 ? '...' : ''}</div>
									<div class="storage-size">${item.size} bytes</div>
								</div>
							`).join('')}
						</div>
					</div>
				`;
			}
		}

		// Enhanced AssetSearch with authentication integration
		class AuthenticatedAssetSearch extends AssetSearch {
			constructor() {
				super();
				this.auth = cdnApp.auth;
			}

			// Override upload methods to include authentication
			async handleDirectUpload() {
				if (!this.auth.isAuthenticated()) {
					this.auth.showAuthModal(true);
					return;
				}

				const uploadPathHint = document.getElementById('uploadPath').value || '';
				const progressEl = document.getElementById('uploadProgress');
				const progressFill = document.getElementById('progressFill');
				const progressText = document.getElementById('progressText');

				progressEl.style.display = 'block';

				for (let i = 0; i < this.selectedFiles.length; i++) {
					const file = this.selectedFiles[i];
					const fileName = file.name;

					progressText.textContent = `Uploading ${fileName} with obfuscated naming (${i + 1}/${this.selectedFiles.length})`;

					const formData = new FormData();
					formData.append('file', file);
					formData.append('path', uploadPathHint);

					const response = await fetch('/api/upload/direct', {
						method: 'POST',
						headers: this.auth.getAuthHeader(),
						body: formData,
					});

					if (!response.ok) {
						if (response.status === 401) {
							this.auth.showAuthModal(true);
							return;
						}
						throw new Error(`Failed to upload ${fileName}: ${response.statusText}`);
					}

					const result = await response.json();
					this.lastUploadResult = {
						...result,
						method: 'Direct Upload (Authenticated)',
						fileName: fileName,
						obfuscatedPath: result.path,
						originalPathHint: result.originalPath || uploadPathHint,
					};

					const progress = ((i + 1) / this.selectedFiles.length) * 100;
					progressFill.style.width = `${progress}%`;
				}

				progressEl.style.display = 'none';
			}

			async handleDatabaseUpload() {
				if (!this.auth.isAuthenticated()) {
					this.auth.showAuthModal(true);
					return;
				}

				const assetName = document.getElementById('assetName').value;
				const category = document.getElementById('assetCategory').value;
				const description = document.getElementById('assetDescription').value;
				const tags = document.getElementById('assetTags').value;

				if (!assetName.trim()) {
					throw new Error('Asset name is required');
				}

				const progressEl = document.getElementById('uploadProgressDb');
				const progressFill = document.getElementById('progressFillDb');
				const progressText = document.getElementById('progressTextDb');

				progressEl.style.display = 'block';

				for (let i = 0; i < this.selectedFiles.length; i++) {
					const file = this.selectedFiles[i];

					progressText.textContent = `Uploading ${file.name} to database (${i + 1}/${this.selectedFiles.length})`;

					const formData = new FormData();
					formData.append('file', file);
					formData.append('name', assetName);
					formData.append('category', category);
					formData.append('description', description);
					formData.append('tags', tags);

					const response = await fetch('/api/upload/database', {
						method: 'POST',
						headers: this.auth.getAuthHeader(),
						body: formData,
					});

					if (!response.ok) {
						if (response.status === 401) {
							this.auth.showAuthModal(true);
							return;
						}
						throw new Error(`Failed to upload ${file.name}: ${response.statusText}`);
					}

					const result = await response.json();
					this.lastUploadResult = {
						...result,
						method: 'Database Storage (Authenticated)',
						fileName: file.name,
						obfuscatedPath: result.path,
						originalCategory: result.originalCategory,
					};

					const progress = ((i + 1) / this.selectedFiles.length) * 100;
					progressFill.style.width = `${progress}%`;
				}

				progressEl.style.display = 'none';
			}
		}

		// File Editor Modal Class
		class FileEditorModal {
			constructor() {
				this.modal = document.getElementById('fileEditorModal');
				this.closeBtn = document.getElementById('fileEditorClose');
				this.fileListContainer = document.getElementById('fileListContainer');
				this.fileSearchInput = document.getElementById('fileSearchInput');
				this.refreshFilesBtn = document.getElementById('refreshFilesBtn');
				this.currentFileSection = document.getElementById('currentFileSection');
				this.currentFileInfo = document.getElementById('currentFileInfo');
				this.saveActionsSection = document.getElementById('saveActionsSection');
				this.changeDescription = document.getElementById('changeDescription');
				this.saveChangesBtn = document.getElementById('saveChangesBtn');
				this.discardChangesBtn = document.getElementById('discardChangesBtn');
				this.viewVersionsBtn = document.getElementById('viewVersionsBtn');
				this.downloadFileBtn = document.getElementById('downloadFileBtn');

				// Editor elements
				this.editorTabs = document.getElementById('editorTabs');
				this.contentEditor = document.getElementById('contentEditor');
				this.infoArea = document.getElementById('infoArea');
				this.metadataEditor = document.getElementById('metadataEditor');
				this.previewArea = document.getElementById('previewArea');

				// Content mode elements
				this.contentModeSelector = document.getElementById('contentModeSelector');
				this.viewerModeBtn = document.getElementById('viewerModeBtn');
				this.editorModeBtn = document.getElementById('editorModeBtn');
				this.advancedModeBtn = document.getElementById('advancedModeBtn');
				this.contentTypeIndicator = document.getElementById('contentTypeIndicator');
				this.contentViewer = document.getElementById('contentViewer');
				this.viewerContainer = document.getElementById('viewerContainer');
				this.contentEditorMode = document.getElementById('contentEditorMode');
				this.advancedEditorMode = document.getElementById('advancedEditorMode');

				// Text editor elements
				this.codeEditor = document.getElementById('codeEditor');
				this.lineNumbers = document.getElementById('lineNumbers');
				this.languageSelect = document.getElementById('languageSelect');
				this.cursorPosition = document.getElementById('cursorPosition');
				this.fileSize = document.getElementById('fileSize');
				this.changeStatus = document.getElementById('changeStatus');
				this.fileType = document.getElementById('fileType');

				// Info area elements
				this.infoFileName = document.getElementById('infoFileName');
				this.infoFileSize = document.getElementById('infoFileSize');
				this.infoMimeType = document.getElementById('infoMimeType');
				this.infoCreated = document.getElementById('infoCreated');
				this.infoModified = document.getElementById('infoModified');
				this.infoFileId = document.getElementById('infoFileId');
				this.versionsContainer = document.getElementById('versionsContainer');
				this.refreshVersionsBtn = document.getElementById('refreshVersionsBtn');

				// Metadata form elements
				this.metaFileName = document.getElementById('metaFileName');
				this.metaDescription = document.getElementById('metaDescription');
				this.metaCategory = document.getElementById('metaCategory');
				this.metaTags = document.getElementById('metaTags');
				this.tagsDisplay = document.getElementById('tagsDisplay');
				this.customFieldsContainer = document.getElementById('customFieldsContainer');
				this.addCustomFieldBtn = document.getElementById('addCustomFieldBtn');

				// Toolbar buttons
				this.undoBtn = document.getElementById('undoBtn');
				this.redoBtn = document.getElementById('redoBtn');
				this.formatBtn = document.getElementById('formatBtn');
				this.wrapBtn = document.getElementById('wrapBtn');

				// Preview container
				this.previewContainer = document.getElementById('previewContainer');

				// Advanced editor elements
				this.editorTypeSelector = document.getElementById('editorTypeSelector');
				this.iframeEditorBtn = document.getElementById('iframeEditorBtn');
				this.apiEditorBtn = document.getElementById('apiEditorBtn');
				this.iframeEditorContent = document.getElementById('iframeEditorContent');
				this.apiEditorContent = document.getElementById('apiEditorContent');
				this.openIframeEditorBtn = document.getElementById('openIframeEditorBtn');
				this.iframeEditorContainer = document.getElementById('iframeEditorContainer');
				this.advancedEditorFrame = document.getElementById('advancedEditorFrame');
				this.pdfOperations = document.getElementById('pdfOperations');
				this.imageOperations = document.getElementById('imageOperations');
				this.audioOperations = document.getElementById('audioOperations');
				this.operationConfig = document.getElementById('operationConfig');
				this.configForm = document.getElementById('configForm');
				this.executeOperationBtn = document.getElementById('executeOperationBtn');
				this.cancelOperationBtn = document.getElementById('cancelOperationBtn');

				// State
				this.currentFile = null;
				this.originalContent = null;
				this.originalMetadata = null;
				this.hasUnsavedChanges = false;
				this.files = [];
				this.filteredFiles = [];
				this.tags = [];
				this.customFields = [];
				this.undoStack = [];
				this.redoStack = [];
				this.maxUndoSteps = 50;
				this.currentEditorType = 'iframe'; // iframe or api
				this.currentOperation = null;

				this.setupEventListeners();
			}

			setupEventListeners() {
				// Modal controls
				this.closeBtn.addEventListener('click', () => this.hide());
				this.modal.addEventListener('click', (e) => {
					if (e.target === this.modal) this.hide();
				});

				// File management
				this.refreshFilesBtn.addEventListener('click', () => this.loadFiles());
				this.fileSearchInput.addEventListener('input', (e) => this.filterFiles(e.target.value));

				// Editor tabs
				this.editorTabs.addEventListener('click', (e) => {
					const tab = e.target.closest('.editor-tab');
					if (tab) this.switchTab(tab.dataset.tab);
				});

				// Content editor
				this.codeEditor.addEventListener('input', () => this.handleContentChange());
				this.codeEditor.addEventListener('scroll', () => this.syncLineNumbers());
				this.codeEditor.addEventListener('keyup', () => this.updateCursorPosition());
				this.codeEditor.addEventListener('click', () => this.updateCursorPosition());
				this.languageSelect.addEventListener('change', () => this.updateLanguage());

				// Toolbar buttons
				this.undoBtn.addEventListener('click', () => this.undo());
				this.redoBtn.addEventListener('click', () => this.redo());
				this.formatBtn.addEventListener('click', () => this.formatCode());
				this.wrapBtn.addEventListener('click', () => this.toggleWordWrap());

				// Metadata editor
				this.metaFileName.addEventListener('input', () => this.handleMetadataChange());
				this.metaDescription.addEventListener('input', () => this.handleMetadataChange());
				this.metaCategory.addEventListener('change', () => this.handleMetadataChange());
				this.metaTags.addEventListener('keydown', (e) => this.handleTagInput(e));
				this.addCustomFieldBtn.addEventListener('click', () => this.addCustomField());

				// Save actions
				this.saveChangesBtn.addEventListener('click', () => this.saveChanges());
				this.discardChangesBtn.addEventListener('click', () => this.discardChanges());
				this.viewVersionsBtn.addEventListener('click', () => this.viewVersionHistory());
				this.downloadFileBtn.addEventListener('click', () => this.downloadFile());

				// Info area
				this.refreshVersionsBtn.addEventListener('click', () => this.loadVersions());

				// Content mode switching
				this.viewerModeBtn.addEventListener('click', () => this.switchContentMode('viewer'));
				this.editorModeBtn.addEventListener('click', () => this.switchContentMode('editor'));
				this.advancedModeBtn.addEventListener('click', () => this.switchContentMode('advanced'));

				// Advanced editor
				this.iframeEditorBtn.addEventListener('click', () => this.switchEditorType('iframe'));
				this.apiEditorBtn.addEventListener('click', () => this.switchEditorType('api'));
				this.openIframeEditorBtn.addEventListener('click', () => this.openIframeEditor());
				this.executeOperationBtn.addEventListener('click', () => this.executeOperation());
				this.cancelOperationBtn.addEventListener('click', () => this.cancelOperation());

				// Operation buttons
				document.addEventListener('click', (e) => {
					if (e.target.classList.contains('operation-btn')) {
						this.selectOperation(e.target.dataset.operation);
					}
				});

				// Keyboard shortcuts
				document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
			}

			async show() {
				if (!cdnApp.auth.isAuthenticated()) {
					cdnApp.auth.showAuthModal(true);
					return;
				}

				// Copy background content
				const backgroundContent = document.querySelector('#fileEditorModal .modal-background-content');
				const mainContent = document.querySelector('.container');
				if (backgroundContent && mainContent) {
					backgroundContent.innerHTML = mainContent.outerHTML;
				}

				await this.loadFiles();
				this.modal.classList.add('show');
			}

			hide() {
				if (this.hasUnsavedChanges) {
					if (!confirm('You have unsaved changes. Are you sure you want to close the editor?')) {
						return;
					}
				}
				this.modal.classList.remove('show');
				this.resetEditor();
			}

			updateAdvancedEditor() {
				if (!this.currentFile) {
					return;
				}

				const mimeType = this.currentFile.mimeType || 'application/octet-stream';

				// Show/hide advanced mode button based on file type
				const supportsAdvanced = this.supportsAdvancedEditing(mimeType);
				this.advancedModeBtn.style.display = supportsAdvanced ? 'flex' : 'none';

				if (!supportsAdvanced) {
					// Switch back to viewer mode if advanced editing is not supported
					this.switchContentMode('viewer');
					return;
				}

				// Update operation groups based on file type
				this.updateOperationGroups(mimeType);

				// Initialize editor type
				this.switchEditorType(this.currentEditorType);
			}

			supportsAdvancedEditing(mimeType) {
				return mimeType.includes('pdf') ||
					   mimeType.startsWith('image/') ||
					   mimeType.startsWith('audio/') ||
					   mimeType.startsWith('video/');
			}

			updateOperationGroups(mimeType) {
				// Hide all operation groups
				this.pdfOperations.style.display = 'none';
				this.imageOperations.style.display = 'none';
				this.audioOperations.style.display = 'none';

				// Show relevant operation group
				if (mimeType.includes('pdf')) {
					this.pdfOperations.style.display = 'block';
				} else if (mimeType.startsWith('image/')) {
					this.imageOperations.style.display = 'block';
				} else if (mimeType.startsWith('audio/')) {
					this.audioOperations.style.display = 'block';
				}
			}

			switchEditorType(type) {
				this.currentEditorType = type;

				// Update editor type buttons
				this.iframeEditorBtn.classList.toggle('active', type === 'iframe');
				this.apiEditorBtn.classList.toggle('active', type === 'api');

				// Show/hide editor content
				this.iframeEditorContent.style.display = type === 'iframe' ? 'block' : 'none';
				this.apiEditorContent.style.display = type === 'api' ? 'block' : 'none';

				// Reset operation config
				this.operationConfig.style.display = 'none';
				this.currentOperation = null;
			}

			async openIframeEditor() {
				if (!this.currentFile) {
					alert('No file selected');
					return;
				}

				try {
					const mimeType = this.currentFile.mimeType || 'application/octet-stream';
					let editorType = 'pdf';

					if (mimeType.startsWith('image/')) {
						editorType = 'image';
					} else if (mimeType.startsWith('audio/')) {
						editorType = 'audio';
					} else if (mimeType.startsWith('video/')) {
						editorType = 'video';
					}

					const response = await fetch(`/api/iframe-editor/${editorType}/${this.currentFile.id}`, {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						throw new Error('Failed to get editor URL');
					}

					const result = await response.json();

					// Open in new window to avoid X-Frame-Options issues
					if (result.editorUrl) {
						const editorWindow = window.open(result.editorUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
						if (editorWindow) {
							// Focus the new window
							editorWindow.focus();

							// Set up message listener for Photopea integration
							if (editorType === 'image') {
								this.setupPhotopeaIntegration(editorWindow);
							}

							// Update button text temporarily
							this.openIframeEditorBtn.textContent = 'Editor Opened in New Window';
							this.openIframeEditorBtn.disabled = true;

							// Reset button after a delay
							setTimeout(() => {
								this.openIframeEditorBtn.textContent = 'Open Web Editor';
								this.openIframeEditorBtn.disabled = false;
							}, 3000);
						} else {
							alert('Please allow popups to open the editor in a new window.');
						}
					}

				} catch (error) {
					console.error('Open iframe editor error:', error);
					alert('Failed to open editor: ' + error.message);
				}
			}

			setupPhotopeaIntegration(editorWindow) {
				// Set up message listener for Photopea Live API
				const messageHandler = async (event) => {
					// Only process messages from Photopea
					if (event.origin !== 'https://www.photopea.com') {
						return;
					}

					const message = event.data;
					if (message && message.type === 'photopea-cdn') {
						console.log('Photopea message:', message);

						switch (message.action) {
							case 'ready':
								console.log('Photopea editor is ready');
								this.showNotification('Photopea editor loaded successfully', 'success');
								break;

							case 'save':
								await this.handlePhotopeaSave(message);
								break;

							case 'echo':
								console.log('Photopea echo:', message.message);
								break;

							default:
								console.log('Unknown Photopea action:', message.action);
						}
					}
				};

				// Add message listener
				window.addEventListener('message', messageHandler);

				// Clean up listener when window is closed
				const checkClosed = setInterval(() => {
					if (editorWindow.closed) {
						window.removeEventListener('message', messageHandler);
						clearInterval(checkClosed);
						console.log('Photopea integration cleaned up');
					}
				}, 1000);
			}

			async handlePhotopeaSave(message) {
				try {
					const isAutoSave = message.auto === true;

					if (!isAutoSave) {
						console.log('Saving image from Photopea...', {
							fileId: message.fileId,
							format: message.format,
							size: message.size
						});
					}

					const response = await fetch(`/api/photopea-save/${message.fileId}`, {
						method: 'POST',
						headers: {
							...cdnApp.auth.getAuthHeader(),
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: 'save',
							format: message.format,
							data: message.data,
							size: message.size
						})
					});

					if (!response.ok) {
						throw new Error('Failed to save image to CDN');
					}

					const result = await response.json();

					if (isAutoSave) {
						console.log('Auto-save completed:', result);
						// Show subtle notification for auto-save
						this.showNotification(`Auto-saved (v${result.version})`, 'info', 2000);
					} else {
						console.log('Manual save completed:', result);
						// Show prominent notification for manual save
						this.showNotification(`Image saved successfully! New version: ${result.version}`, 'success');

						// Refresh the file in the editor for manual saves
						await this.selectFile(message.fileId);
					}

				} catch (error) {
					console.error('Failed to save image from Photopea:', error);
					this.showNotification('Failed to save image: ' + error.message, 'error');
				}
			}

			showNotification(message, type = 'info', duration = 5000) {
				// Create notification element
				const notification = document.createElement('div');
				notification.className = `notification notification-${type}`;
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
					color: white;
					padding: 12px 20px;
					border-radius: 8px;
					box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
					z-index: 10000;
					max-width: 400px;
					font-size: 14px;
					line-height: 1.4;
					animation: slideIn 0.3s ease-out;
				`;
				notification.textContent = message;

				// Add animation styles
				if (!document.getElementById('notification-styles')) {
					const style = document.createElement('style');
					style.id = 'notification-styles';
					style.textContent = `
						@keyframes slideIn {
							from { transform: translateX(100%); opacity: 0; }
							to { transform: translateX(0); opacity: 1; }
						}
						@keyframes slideOut {
							from { transform: translateX(0); opacity: 1; }
							to { transform: translateX(100%); opacity: 0; }
						}
					`;
					document.head.appendChild(style);
				}

				document.body.appendChild(notification);

				// Auto-remove after specified duration
				setTimeout(() => {
					notification.style.animation = 'slideOut 0.3s ease-in';
					setTimeout(() => {
						if (notification.parentNode) {
							notification.parentNode.removeChild(notification);
						}
					}, 300);
				}, duration);

				// Click to dismiss
				notification.addEventListener('click', () => {
					notification.style.animation = 'slideOut 0.3s ease-in';
					setTimeout(() => {
						if (notification.parentNode) {
							notification.parentNode.removeChild(notification);
						}
					}, 300);
				});
			}

			selectOperation(operation) {
				this.currentOperation = operation;

				// Update operation button states
				document.querySelectorAll('.operation-btn').forEach(btn => {
					btn.classList.toggle('active', btn.dataset.operation === operation);
				});

				// Show operation config
				this.showOperationConfig(operation);
			}

			showOperationConfig(operation) {
				this.operationConfig.style.display = 'block';
				this.configForm.innerHTML = this.generateOperationForm(operation);
			}

			generateOperationForm(operation) {
				const mimeType = this.currentFile?.mimeType || '';

				if (mimeType.includes('pdf')) {
					return this.generatePDFOperationForm(operation);
				} else if (mimeType.startsWith('image/')) {
					return this.generateImageOperationForm(operation);
				} else if (mimeType.startsWith('audio/')) {
					return this.generateAudioOperationForm(operation);
				}

				return '<p>No configuration needed for this operation.</p>';
			}

			generatePDFOperationForm(operation) {
				switch (operation) {
					case 'add-text':
						return `
							<div class="form-group">
								<label class="form-label">Text to Add</label>
								<input type="text" class="form-input" id="pdfText" placeholder="Enter text" required />
							</div>
							<div class="form-group">
								<label class="form-label">Page Number</label>
								<input type="number" class="form-input" id="pdfPage" placeholder="1" min="1" value="1" />
							</div>
							<div class="form-group">
								<label class="form-label">Position X</label>
								<input type="number" class="form-input" id="pdfX" placeholder="50" value="50" />
							</div>
							<div class="form-group">
								<label class="form-label">Position Y</label>
								<input type="number" class="form-input" id="pdfY" placeholder="50" value="50" />
							</div>
						`;
					case 'rotate':
						return `
							<div class="form-group">
								<label class="form-label">Rotation Angle</label>
								<select class="form-select" id="pdfRotation">
									<option value="90">90° Clockwise</option>
									<option value="180">180°</option>
									<option value="270">270° Clockwise</option>
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Pages (comma-separated, or "all")</label>
								<input type="text" class="form-input" id="pdfPages" placeholder="all" value="all" />
							</div>
						`;
					case 'split':
						return `
							<div class="form-group">
								<label class="form-label">Split Method</label>
								<select class="form-select" id="pdfSplitMethod">
									<option value="pages">By Page Range</option>
									<option value="each">Each Page Separate</option>
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Page Range (e.g., 1-5,7,9-12)</label>
								<input type="text" class="form-input" id="pdfPageRange" placeholder="1-5" />
							</div>
						`;
					default:
						return '<p>No additional configuration needed.</p>';
				}
			}

			generateImageOperationForm(operation) {
				switch (operation) {
					case 'resize':
						return `
							<div class="form-group">
								<label class="form-label">Width (pixels)</label>
								<input type="number" class="form-input" id="imageWidth" placeholder="800" />
							</div>
							<div class="form-group">
								<label class="form-label">Height (pixels)</label>
								<input type="number" class="form-input" id="imageHeight" placeholder="600" />
							</div>
							<div class="form-group">
								<label class="form-label">
									<input type="checkbox" id="imageMaintainRatio" checked /> Maintain aspect ratio
								</label>
							</div>
						`;
					case 'crop':
						return `
							<div class="form-group">
								<label class="form-label">X Position</label>
								<input type="number" class="form-input" id="cropX" placeholder="0" value="0" />
							</div>
							<div class="form-group">
								<label class="form-label">Y Position</label>
								<input type="number" class="form-input" id="cropY" placeholder="0" value="0" />
							</div>
							<div class="form-group">
								<label class="form-label">Width</label>
								<input type="number" class="form-input" id="cropWidth" placeholder="200" />
							</div>
							<div class="form-group">
								<label class="form-label">Height</label>
								<input type="number" class="form-input" id="cropHeight" placeholder="200" />
							</div>
						`;
					case 'rotate':
						return `
							<div class="form-group">
								<label class="form-label">Rotation Angle</label>
								<select class="form-select" id="imageRotation">
									<option value="90">90° Clockwise</option>
									<option value="180">180°</option>
									<option value="270">270° Clockwise</option>
									<option value="custom">Custom Angle</option>
								</select>
							</div>
							<div class="form-group" id="customAngleGroup" style="display: none;">
								<label class="form-label">Custom Angle (degrees)</label>
								<input type="number" class="form-input" id="customAngle" placeholder="45" />
							</div>
						`;
					case 'filter':
						return `
							<div class="form-group">
								<label class="form-label">Filter Type</label>
								<select class="form-select" id="imageFilter">
									<option value="blur">Blur</option>
									<option value="sharpen">Sharpen</option>
									<option value="brightness">Brightness</option>
									<option value="contrast">Contrast</option>
									<option value="grayscale">Grayscale</option>
									<option value="sepia">Sepia</option>
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Intensity (0-100)</label>
								<input type="range" class="form-input" id="filterIntensity" min="0" max="100" value="50" />
								<span id="intensityValue">50</span>
							</div>
						`;
					case 'compress':
						return `
							<div class="form-group">
								<label class="form-label">Quality (1-100)</label>
								<input type="range" class="form-input" id="imageQuality" min="1" max="100" value="80" />
								<span id="qualityValue">80</span>
							</div>
							<div class="form-group">
								<label class="form-label">Output Format</label>
								<select class="form-select" id="imageFormat">
									<option value="jpeg">JPEG</option>
									<option value="png">PNG</option>
									<option value="webp">WebP</option>
								</select>
							</div>
						`;
					default:
						return '<p>No additional configuration needed.</p>';
				}
			}

			generateAudioOperationForm(operation) {
				switch (operation) {
					case 'trim':
						return `
							<div class="form-group">
								<label class="form-label">Start Time (seconds)</label>
								<input type="number" class="form-input" id="audioStart" placeholder="0" value="0" step="0.1" />
							</div>
							<div class="form-group">
								<label class="form-label">End Time (seconds)</label>
								<input type="number" class="form-input" id="audioEnd" placeholder="30" step="0.1" />
							</div>
						`;
					case 'fade':
						return `
							<div class="form-group">
								<label class="form-label">Fade Type</label>
								<select class="form-select" id="fadeType">
									<option value="in">Fade In</option>
									<option value="out">Fade Out</option>
									<option value="both">Both</option>
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Fade Duration (seconds)</label>
								<input type="number" class="form-input" id="fadeDuration" placeholder="2" value="2" step="0.1" />
							</div>
						`;
					case 'convert':
						return `
							<div class="form-group">
								<label class="form-label">Output Format</label>
								<select class="form-select" id="audioFormat">
									<option value="mp3">MP3</option>
									<option value="wav">WAV</option>
									<option value="ogg">OGG</option>
									<option value="aac">AAC</option>
								</select>
							</div>
							<div class="form-group">
								<label class="form-label">Bitrate (kbps)</label>
								<select class="form-select" id="audioBitrate">
									<option value="128">128</option>
									<option value="192">192</option>
									<option value="256">256</option>
									<option value="320">320</option>
								</select>
							</div>
						`;
					default:
						return '<p>No additional configuration needed.</p>';
				}
			}

			async executeOperation() {
				if (!this.currentFile || !this.currentOperation) {
					alert('No file or operation selected');
					return;
				}

				try {
					const mimeType = this.currentFile.mimeType || '';
					let editType = 'pdf';

					if (mimeType.startsWith('image/')) {
						editType = 'image';
					} else if (mimeType.startsWith('audio/')) {
						editType = 'audio';
					}

					const options = this.collectOperationOptions();

					const response = await fetch(`/api/edit/${editType}/${this.currentFile.id}`, {
						method: 'POST',
						headers: {
							...cdnApp.auth.getAuthHeader(),
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							operation: this.currentOperation,
							options
						})
					});

					if (!response.ok) {
						throw new Error('Operation failed');
					}

					const result = await response.json();
					alert('Operation completed successfully!');

					// Reload file to show changes
					await this.selectFile(this.currentFile.id);
					this.cancelOperation();

				} catch (error) {
					console.error('Execute operation error:', error);
					alert('Operation failed: ' + error.message);
				}
			}

			collectOperationOptions() {
				const options = {};
				const formInputs = this.configForm.querySelectorAll('input, select');

				formInputs.forEach(input => {
					if (input.type === 'checkbox') {
						options[input.id] = input.checked;
					} else if (input.type === 'range') {
						options[input.id] = parseInt(input.value);
					} else if (input.type === 'number') {
						options[input.id] = parseFloat(input.value) || 0;
					} else {
						options[input.id] = input.value;
					}
				});

				return options;
			}

			cancelOperation() {
				this.currentOperation = null;
				this.operationConfig.style.display = 'none';

				// Clear active states
				document.querySelectorAll('.operation-btn').forEach(btn => {
					btn.classList.remove('active');
				});
			}

			async loadFiles() {
				this.showLoading();
				try {
					const response = await fetch('/api/user/uploads?limit=100', {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						if (response.status === 401) {
							cdnApp.auth.showAuthModal(true);
							return;
						}
						throw new Error('Failed to load files');
					}

					const result = await response.json();
					this.files = result.uploads || [];
					this.filteredFiles = [...this.files];
					for (let index = 0; index < this.files.length; index++) {
						const file = this.files[index];
						file.mimeType = file.mimeType ?? file.type ?? file.mime_type;
						this.files[index] = file;
					}
					this.renderFileList();

				} catch (error) {
					console.error('Load files error:', error);
					this.showError('Failed to load files: ' + error.message);
				}
			}

			showLoading() {
				this.fileListContainer.innerHTML = `
					<div class="loading-spinner">
						<div class="spinner"></div>
						<span>Loading files...</span>
					</div>
				`;
			}

			showError(message) {
				this.fileListContainer.innerHTML = `
					<div class="loading-spinner">
						<span style="color: hsl(var(--destructive));">${message}</span>
					</div>
				`;
			}

			filterFiles(query) {
				if (!query.trim()) {
					this.filteredFiles = [...this.files];
				} else {
					const searchTerm = query.toLowerCase();
					this.filteredFiles = this.files.filter(file =>
						file.name.toLowerCase().includes(searchTerm) ||
						file.originalName.toLowerCase().includes(searchTerm) ||
						(file.category && file.category.toLowerCase().includes(searchTerm)) ||
						(file.tags && file.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
					);
				}
				this.renderFileList();
			}

			renderFileList() {
				if (this.filteredFiles.length === 0) {
					this.fileListContainer.innerHTML = `
						<div class="loading-spinner">
							<span>No files found</span>
						</div>
					`;
					return;
				}

				this.fileListContainer.innerHTML = this.filteredFiles.map(file => `
					<div class="file-item" data-file-id="${file.id}">
						<div class="file-item-icon">
							${this.getFileIcon(file.mimeType || file.type)}
						</div>
						<div class="file-item-info">
							<div class="file-item-name">${file.name}</div>
							<div class="file-item-meta">
								<span>${this.formatFileSize(file.size)}</span>
								<span>${file.category || 'No category'}</span>
								<span>${new Date(file.uploadedAt).toLocaleDateString()}</span>
							</div>
						</div>
					</div>
				`).join('');

				// Add click listeners
				this.fileListContainer.querySelectorAll('.file-item').forEach(item => {
					item.addEventListener('click', () => {
						const fileId = item.dataset.fileId;
						this.selectFile(fileId);
					});
				});
			}

			getFileIcon(mimeType) {
				if (mimeType == undefined || mimeType == null || mimeType == ''){
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
						<polyline points="14,2 14,8 20,8"/>
					</svg>`;
				}
				if(mimeType.startsWith('application/')) {
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
						<polyline points="14,2 14,8 20,8"/>
					</svg>`;
				}
				if (mimeType.startsWith('image/')) {
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
						<circle cx="9" cy="9" r="2"/>
						<path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
					</svg>`;
				} else if (mimeType.startsWith('video/')) {
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<polygon points="23 7 16 12 23 17 23 7"/>
						<rect width="15" height="14" x="1" y="5" rx="2" ry="2"/>
					</svg>`;
				} else if (mimeType.startsWith('audio/')) {
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M9 18V5l12-2v13"/>
						<circle cx="6" cy="18" r="3"/>
						<circle cx="18" cy="16" r="3"/>
					</svg>`;
				} else if (mimeType.includes('javascript') || mimeType.includes('json')) {
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<polyline points="16,18 22,12 16,6"/>
						<polyline points="8,6 2,12 8,18"/>
					</svg>`;
				} else if (mimeType.includes('html') || mimeType.includes('css')) {
					return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
						<polyline points="14,2 14,8 20,8"/>
						<line x1="16" y1="13" x2="8" y2="13"/>
						<line x1="16" y1="17" x2="8" y2="17"/>
						<polyline points="10,9 9,9 8,9"/>
					</svg>`;
				}
				return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
					<polyline points="14,2 14,8 20,8"/>
				</svg>`;
			}

			async selectFileById(fileId) {
				// Open the file editor and select the file
				await this.show();
				await this.selectFile(fileId);
			}

			async selectFile(fileId) {
				const file = this.files.find(f => f.id === fileId);
				if (!file) return;

				// Check for unsaved changes
				if (this.hasUnsavedChanges) {
					if (!confirm('You have unsaved changes. Do you want to discard them and select a new file?')) {
						return;
					}
				}

				try {
					// Load file details and content
					const response = await fetch(`/api/file-editor/${fileId}/info`, {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						throw new Error('Failed to load file details');
					}

					const result = await response.json();
					this.currentFile = {
						...result.file,
						...file
					}
					const content = await fetch(file.path, {
						headers: cdnApp.auth.getAuthHeader()
					});
					if (!content.ok) {
						throw new Error('Failed to load file content');
					}
					this.originalContent = await content.text();
					this.originalMetadata = {
						name: this.currentFile.name,
						description: this.currentFile.description || '',
						category: this.currentFile.category || '',
						tags: [...(this.currentFile.tags || [])],
						customFields: {...(this.currentFile.customFields || {})}
					};

					this.updateFileSelection(fileId);
					this.populateEditor();
					this.showCurrentFileInfo();
					this.updatePreview();
					this.resetChangeTracking();

				} catch (error) {
					console.error('Select file error:', error);
					alert('Failed to load file: ' + error.message);
				}
			}

			updateFileSelection(selectedId) {
				this.fileListContainer.querySelectorAll('.file-item').forEach(item => {
					item.classList.toggle('selected', item.dataset.fileId === selectedId);
				});
			}

			populateEditor() {
				if (!this.currentFile) return;

				// Determine best content mode based on file type
				const mimeType = this.currentFile.mimeType || 'application/octet-stream';
				const fileName = this.currentFile.name;
				const isEditable = this.isTextFile(mimeType, fileName);

				// Set appropriate content mode
				if (isEditable) {
					// For text files, default to editor mode but allow switching
					this.editorModeBtn.style.display = 'flex';
					this.switchContentMode('editor');

					// Populate content editor
					this.codeEditor.value = this.originalContent || '';
					this.updateLineNumbers();
					this.updateCursorPosition();
					this.updateFileSize();
					this.detectLanguage();
				} else {
					// For non-text files, hide editor mode and use viewer
					this.editorModeBtn.style.display = 'none';
					this.switchContentMode('viewer');
				}

				// Populate metadata editor
				this.metaFileName.value = this.originalMetadata.name;
				this.metaDescription.value = this.originalMetadata.description;
				this.metaCategory.value = this.originalMetadata.category;
				this.populateTags();
				this.populateCustomFields();

				// Update content viewer
				this.updateContentViewer();

				// Update advanced editor
				this.updateAdvancedEditor();
			}

			populateTags() {
				this.tags = [...this.originalMetadata.tags];
				this.renderTags();
			}

			renderTags() {
				this.tagsDisplay.innerHTML = this.tags.map(tag => `
					<div class="tag-item">
						<span>${tag}</span>
						<button class="tag-remove" onclick="window.cdnApp.fileEditor.removeTag('${tag}')">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<line x1="18" y1="6" x2="6" y2="18"/>
								<line x1="6" y1="6" x2="18" y2="18"/>
							</svg>
						</button>
					</div>
				`).join('');
			}

			populateCustomFields() {
				this.customFields = Object.entries(this.originalMetadata.customFields).map(([key, value]) => ({ key, value }));
				this.renderCustomFields();
			}

			renderCustomFields() {
				const fieldsHtml = this.customFields.map((field, index) => `
					<div class="custom-field">
						<div class="form-group">
							<label class="form-label">Field Name</label>
							<input type="text" class="form-input" value="${field.key}" onchange="window.cdnApp.fileEditor.updateCustomField(${index}, 'key', this.value)" />
						</div>
						<div class="form-group">
							<label class="form-label">Field Value</label>
							<input type="text" class="form-input" value="${field.value}" onchange="window.cdnApp.fileEditor.updateCustomField(${index}, 'value', this.value)" />
						</div>
						<button class="remove-field-btn" onclick="window.cdnApp.fileEditor.removeCustomField(${index})">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<line x1="18" y1="6" x2="6" y2="18"/>
								<line x1="6" y1="6" x2="18" y2="18"/>
							</svg>
						</button>
					</div>
				`).join('');

				this.customFieldsContainer.innerHTML = fieldsHtml + `
					<button class="add-field-btn" onclick="window.cdnApp.fileEditor.addCustomField()">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="12" y1="5" x2="12" y2="19"/>
							<line x1="5" y1="12" x2="19" y2="12"/>
						</svg>
						Add Custom Field
					</button>
				`;
			}

			showCurrentFileInfo() {
				if (!this.currentFile) return;

				this.currentFileInfo.innerHTML = `
					<div class="current-file-detail">
						<span class="current-file-label">Name</span>
						<span class="current-file-value">${this.currentFile.name}</span>
					</div>
					<div class="current-file-detail">
						<span class="current-file-label">Size</span>
						<span class="current-file-value">${this.formatFileSize(this.currentFile.size)}</span>
					</div>
					<div class="current-file-detail">
						<span class="current-file-label">Type</span>
						<span class="current-file-value">${this.currentFile.mimeType}</span>
					</div>
					<div class="current-file-detail">
						<span class="current-file-label">Modified</span>
						<span class="current-file-value">${new Date(this.currentFile.uploadedAt).toLocaleString()}</span>
					</div>
				`;

				this.currentFileSection.style.display = 'block';
			}

			switchTab(tabName) {
				// Update tab buttons
				this.editorTabs.querySelectorAll('.editor-tab').forEach(tab => {
					tab.classList.toggle('active', tab.dataset.tab === tabName);
				});

				// Update content areas
				document.querySelectorAll('.editor-area').forEach(area => {
					area.classList.toggle('active', area.id === tabName + 'Editor' || area.id === tabName + 'Area');
				});

				// Handle specific tab actions
				if (tabName === 'preview') {
					this.updatePreview();
				} else if (tabName === 'info') {
					this.populateInfoArea();
					this.loadVersions();
				}
			}

			handleContentChange() {
				this.addToUndoStack();
				this.updateLineNumbers();
				this.updateFileSize();
				this.markAsChanged();
				this.updatePreview();
			}

			handleMetadataChange() {
				this.markAsChanged();
			}

			handleTagInput(e) {
				if (e.key === 'Enter' && e.target.value.trim()) {
					e.preventDefault();
					const tag = e.target.value.trim();
					if (!this.tags.includes(tag)) {
						this.tags.push(tag);
						this.renderTags();
						this.handleMetadataChange();
					}
					e.target.value = '';
				}
			}

			addCustomField() {
				this.customFields.push({ key: '', value: '' });
				this.renderCustomFields();
				this.handleMetadataChange();
			}

			removeCustomField(index) {
				this.customFields.splice(index, 1);
				this.renderCustomFields();
				this.handleMetadataChange();
			}

			updateCustomField(index, property, value) {
				if (this.customFields[index]) {
					this.customFields[index][property] = value;
					this.handleMetadataChange();
				}
			}

			removeTag(tag) {
				this.tags = this.tags.filter(t => t !== tag);
				this.renderTags();
				this.handleMetadataChange();
			}

			populateInfoArea() {
				if (!this.currentFile) return;

				this.infoFileName.textContent = this.currentFile.name;
				this.infoFileSize.textContent = this.formatFileSize(this.currentFile.size);
				this.infoMimeType.textContent = this.currentFile.mimeType || 'Unknown';
				this.infoCreated.textContent = new Date(this.currentFile.uploadedAt).toLocaleString();
				this.infoModified.textContent = new Date(this.currentFile.uploadedAt).toLocaleString();
				this.infoFileId.textContent = this.currentFile.id;
			}

			async loadVersions() {
				if (!this.currentFile) return;

				this.versionsContainer.innerHTML = `
					<div class="versions-loading">
						<div class="spinner"></div>
						<span>Loading versions...</span>
					</div>
				`;

				try {
					const response = await fetch(`/api/versions/${this.currentFile.id}`, {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						throw new Error('Failed to load versions');
					}

					const result = await response.json();
					this.renderVersions(result.versions || []);

				} catch (error) {
					console.error('Load versions error:', error);
					this.versionsContainer.innerHTML = `
						<div class="versions-empty">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<circle cx="12" cy="12" r="10"/>
								<line x1="12" y1="8" x2="12" y2="12"/>
								<line x1="12" y1="16" x2="12.01" y2="16"/>
							</svg>
							<p>Failed to load versions</p>
							<small>${error.message}</small>
						</div>
					`;
				}
			}

			renderVersions(versions) {
				if (versions.length === 0) {
					this.versionsContainer.innerHTML = `
						<div class="versions-empty">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
								<polyline points="14,2 14,8 20,8"/>
							</svg>
							<p>No versions found</p>
							<small>This file has no version history</small>
						</div>
					`;
					return;
				}

				this.versionsContainer.innerHTML = versions.map((version, index) => `
					<div class="version-item ${index === 0 ? 'current' : ''}" data-version-id="${version.version}">
						<div class="version-info">
							<div class="version-number">
								${index === 0 ? 'Current Version' : `Version ${versions.length - index}`}
								${version.description ? ` - ${version.description}` : ''}
							</div>
							<div class="version-date">${new Date(version.timestamp).toLocaleString()}</div>
						</div>
						<div class="version-size">${this.formatFileSize(version.changes.contentSize || 0)}</div>
						<div class="version-size">${this.formatFileSize(version.changes.contentHash || 0)}</div>
						<div class="version-actions">
							${index === 0 ? '' : `
								<button class="version-action-btn" title="View this version" onclick="window.fileEditor.viewVersion('${version.version}')">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
										<circle cx="12" cy="12" r="3"/>
									</svg>
								</button>
								<button class="version-action-btn primary" title="Restore this version" onclick="window.fileEditor.restoreVersion('${version.version}')">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
										<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
									</svg>
								</button>
							`}
						</div>
					</div>
				`).join('');
			}

			async viewVersion(versionId) {
				try {
					const response = await fetch(`/api/versions/${versionId}/content`, {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						throw new Error('Failed to load version content');
					}

					const result = await response.json();

					// Open in a new modal or tab for comparison
					const newWindow = window.open('', '_blank');
					newWindow.document.write(`
						<html>
							<head>
								<title>Version ${versionId} - ${this.currentFile.name}</title>
								<style>
									body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #ffffff; }
									pre { white-space: pre-wrap; word-wrap: break-word; }
								</style>
							</head>
							<body>
								<h2>Version ${versionId} - ${this.currentFile.name}</h2>
								<pre>${this.escapeHtml(result.content)}</pre>
							</body>
						</html>
					`);

				} catch (error) {
					console.error('View version error:', error);
					alert('Failed to load version: ' + error.message);
				}
			}

			async restoreVersion(versionId) {
				if (!confirm('Are you sure you want to restore this version? This will replace the current content.')) {
					return;
				}

				try {
					const response = await fetch(`/api/file-editor/version/${versionId}/content`, {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						throw new Error('Failed to load version content');
					}

					const result = await response.json();

					// Update the editor with the version content
					this.codeEditor.value = result.content;
					this.updateLineNumbers();
					this.updateFileSize();
					this.updatePreview();
					this.markAsChanged();

					// Switch to content tab to show the restored content
					this.switchTab('content');

				} catch (error) {
					console.error('Restore version error:', error);
					alert('Failed to restore version: ' + error.message);
				}
			}

			switchContentMode(mode) {
				// Update mode buttons
				document.querySelectorAll('.mode-tab').forEach(tab => {
					tab.classList.toggle('active', tab.dataset.mode === mode);
				});

				// Show/hide content areas
				this.contentViewer.style.display = mode === 'viewer' ? 'flex' : 'none';
				this.contentEditorMode.style.display = mode === 'editor' ? 'flex' : 'none';
				this.advancedEditorMode.style.display = mode === 'advanced' ? 'flex' : 'none';

				if (mode === 'viewer') {
					this.updateContentViewer();
				} else if (mode === 'editor') {
					this.updateLineNumbers();
					this.updateCursorPosition();
				} else if (mode === 'advanced') {
					this.updateAdvancedEditor();
				}
			}

			updateContentViewer() {
				if (!this.currentFile) {
					this.viewerContainer.innerHTML = `
						<div class="viewer-placeholder">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
								<polyline points="14,2 14,8 20,8"/>
							</svg>
							<h3>Content Viewer</h3>
							<p>Select a file to view its content</p>
						</div>
					`;
					return;
				}

				const mimeType = this.currentFile.mimeType || 'application/octet-stream';
				const fileName = this.currentFile.name;
				const filePath = this.currentFile.path;

				// Update content type indicator
				this.contentTypeIndicator.textContent = mimeType;

				// Determine how to display the content
				if (mimeType.startsWith('image/')) {
					this.renderImageViewer(filePath, fileName);
				} else if (mimeType === 'application/pdf') {
					this.renderPDFViewer(filePath, fileName);
				} else if (mimeType.startsWith('audio/')) {
					this.renderAudioViewer(filePath, fileName);
				} else if (mimeType.startsWith('video/')) {
					this.renderVideoViewer(filePath, fileName);
				} else if (this.isTextFile(mimeType, fileName)) {
					this.renderTextViewer();
				} else if (this.isArchiveFile(mimeType, fileName)) {
					this.renderArchiveViewer(fileName);
				} else {
					this.renderUnsupportedViewer(fileName, mimeType);
				}
			}

			isTextFile(mimeType, fileName) {
				const textMimeTypes = [
					'text/',
					'application/json',
					'application/javascript',
					'application/xml',
					'application/x-sh',
					'application/x-yaml'
				];

				const textExtensions = [
					'.txt', '.md', '.html', '.css', '.js', '.ts', '.json', '.xml', '.yaml', '.yml',
					'.sh', '.bat', '.ps1', '.py', '.rb', '.go', '.rs', '.cpp', '.c', '.h',
					'.java', '.cs', '.php', '.sql', '.ini', '.conf', '.log'
				];

				return textMimeTypes.some(type => mimeType.startsWith(type)) ||
					   textExtensions.some(ext => fileName.toLowerCase().endsWith(ext));
			}

			isArchiveFile(mimeType, fileName) {
				const archiveMimeTypes = [
					'application/zip',
					'application/x-tar',
					'application/x-rar-compressed',
					'application/x-7z-compressed',
					'application/gzip'
				];

				const archiveExtensions = ['.zip', '.tar', '.rar', '.7z', '.gz', '.bz2'];

				return archiveMimeTypes.some(type => mimeType.includes(type)) ||
					   archiveExtensions.some(ext => fileName.toLowerCase().endsWith(ext));
			}

			renderImageViewer(filePath, fileName) {
				this.viewerContainer.innerHTML = `
					<div class="viewer-image">
						<img src="${filePath}" alt="${fileName}" onload="this.style.opacity='1'" style="opacity: 0; transition: opacity 0.3s ease;" />
					</div>
				`;
			}

			renderPDFViewer(filePath, fileName) {
				this.viewerContainer.innerHTML = `
					<div class="viewer-pdf">
						<iframe src="${filePath}#toolbar=1&navpanes=1&scrollbar=1"
								title="${fileName}">
							<p>Your browser doesn't support PDF viewing.
							   <a href="${filePath}" target="_blank">Download the PDF</a> to view it.</p>
						</iframe>
					</div>
				`;
			}

			renderAudioViewer(filePath, fileName) {
				this.viewerContainer.innerHTML = `
					<div class="viewer-audio">
						<div class="audio-visualizer">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M9 18V5l12-2v13"/>
								<circle cx="6" cy="18" r="3"/>
								<circle cx="18" cy="16" r="3"/>
							</svg>
							<div style="color: hsl(var(--muted-foreground)); margin-left: 1rem;">
								<h4>${fileName}</h4>
								<p>Audio Visualizer</p>
							</div>
						</div>
						<div class="audio-controls">
							<audio controls preload="metadata">
								<source src="${filePath}" />
								Your browser doesn't support the audio element.
							</audio>
						</div>
					</div>
				`;
			}

			renderVideoViewer(filePath, fileName) {
				this.viewerContainer.innerHTML = `
					<div class="viewer-video">
						<video controls preload="metadata">
							<source src="${filePath}" />
							Your browser doesn't support the video element.
						</video>
					</div>
				`;
			}

			renderTextViewer() {
				const content = this.originalContent || '';
				this.viewerContainer.innerHTML = `
					<div class="viewer-text">
						<div class="text-content">${this.escapeHtml(content)}</div>
					</div>
				`;
			}

			renderArchiveViewer(fileName) {
				this.viewerContainer.innerHTML = `
					<div class="viewer-archive">
						<div class="archive-contents">
							<div class="archive-header">
								<h4>Archive: ${fileName}</h4>
								<p>Archive files cannot be previewed directly. Download to extract contents.</p>
							</div>
							<div class="archive-file-list">
								<div class="archive-file-item">
									<svg class="archive-file-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M22 11v1a10 10 0 1 1-9-10"/>
										<path d="M8 14s1.5 2 4 2 4-2 4-2"/>
										<line x1="9" y1="9" x2="9.01" y2="9"/>
										<line x1="15" y1="9" x2="15.01" y2="9"/>
									</svg>
									<span>Contents available after download</span>
								</div>
							</div>
						</div>
					</div>
				`;
			}

			renderUnsupportedViewer(fileName, mimeType) {
				this.viewerContainer.innerHTML = `
					<div class="viewer-unsupported">
						<svg class="unsupported-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
							<polyline points="14,2 14,8 20,8"/>
							<line x1="12" y1="11" x2="12" y2="17"/>
							<line x1="12" y1="7" x2="12.01" y2="7"/>
						</svg>
						<h3>Preview Not Available</h3>
						<p>File type <code>${mimeType}</code> cannot be previewed.</p>
						<p>File: <strong>${fileName}</strong></p>
						<a href="${this.currentFile.path}" class="download-btn" download="${fileName}">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
								<polyline points="7,10 12,15 17,10"/>
								<line x1="12" y1="15" x2="12" y2="3"/>
							</svg>
							Download File
						</a>
					</div>
				`;
			}

			markAsChanged() {
				this.hasUnsavedChanges = true;
				this.changeStatus.textContent = 'Unsaved changes';
				this.changeStatus.style.color = 'hsl(var(--destructive))';
				this.saveActionsSection.style.display = 'block';
			}

			resetChangeTracking() {
				this.hasUnsavedChanges = false;
				this.changeStatus.textContent = 'No changes';
				this.changeStatus.style.color = 'hsl(var(--muted-foreground))';
				this.saveActionsSection.style.display = 'none';
				this.undoStack = [];
				this.redoStack = [];
			}

			updateLineNumbers() {
				const lines = this.codeEditor.value.split('\n');
				const lineNumbers = lines.map((_, i) => i + 1).join('\n');
				this.lineNumbers.textContent = lineNumbers;
			}

			syncLineNumbers() {
				this.lineNumbers.scrollTop = this.codeEditor.scrollTop;
			}

			updateCursorPosition() {
				const textarea = this.codeEditor;
				const lines = textarea.value.substr(0, textarea.selectionStart).split('\n');
				const line = lines.length;
				const column = lines[lines.length - 1].length + 1;
				this.cursorPosition.textContent = `Line ${line}, Column ${column}`;
			}

			updateFileSize() {
				const size = new Blob([this.codeEditor.value]).size;
				this.fileSize.textContent = this.formatFileSize(size);
			}

			detectLanguage() {
				if (!this.currentFile) return;

				const extension = this.currentFile.name.split('.').pop()?.toLowerCase();
				const mimeType = this.currentFile.mimeType;

				let language = 'text';
				if (extension === 'js' || mimeType.includes('javascript')) language = 'javascript';
				else if (extension === 'ts' || mimeType.includes('typescript')) language = 'typescript';
				else if (extension === 'html' || mimeType.includes('html')) language = 'html';
				else if (extension === 'css' || mimeType.includes('css')) language = 'css';
				else if (extension === 'json' || mimeType.includes('json')) language = 'json';
				else if (extension === 'md' || extension === 'markdown') language = 'markdown';

				this.languageSelect.value = language;
				this.fileType.textContent = language.charAt(0).toUpperCase() + language.slice(1);
			}

			updateLanguage() {
				const language = this.languageSelect.value;
				this.fileType.textContent = language.charAt(0).toUpperCase() + language.slice(1);
			}

			updatePreview() {
				if (!this.currentFile) return;
				console.log(this.currentFile)
				const content = this.codeEditor.value;
				const mimeType = this.currentFile.mimeType;

				if (mimeType.startsWith('image/')) {
					this.previewContainer.innerHTML = `
						<div class="preview-content">
							<img src="${this.currentFile.path}" alt="${this.currentFile.name}" class="preview-image" />
						</div>
					`;
				} else if (mimeType.startsWith('video/')) {
					this.previewContainer.innerHTML = `
						<div class="preview-content">
							<video src="${this.currentFile.path}" controls class="preview-video"></video>
						</div>
					`;
				} else if (mimeType.startsWith('audio/')) {
					this.previewContainer.innerHTML = `
						<div class="preview-content">
							<audio src="${this.currentFile.path}" controls class="preview-audio"></audio>
						</div>
					`;
				} else if (mimeType.includes('html')) {
					this.previewContainer.innerHTML = `
						<div class="preview-content">
							<iframe srcdoc="${content.replace(/"/g, '&quot;')}" style="width: 100%; height: 400px; border: 1px solid hsl(var(--border)); border-radius: var(--radius);"></iframe>
						</div>
					`;
				} else {
					this.previewContainer.innerHTML = `
						<div class="preview-content">
							<pre class="preview-code">${this.escapeHtml(content)}</pre>
						</div>
					`;
				}
			}

			addToUndoStack() {
				this.undoStack.push(this.codeEditor.value);
				if (this.undoStack.length > this.maxUndoSteps) {
					this.undoStack.shift();
				}
				this.redoStack = [];
			}

			undo() {
				if (this.undoStack.length > 0) {
					this.redoStack.push(this.codeEditor.value);
					this.codeEditor.value = this.undoStack.pop();
					this.updateLineNumbers();
					this.updateFileSize();
					this.updatePreview();
				}
			}

			redo() {
				if (this.redoStack.length > 0) {
					this.undoStack.push(this.codeEditor.value);
					this.codeEditor.value = this.redoStack.pop();
					this.updateLineNumbers();
					this.updateFileSize();
					this.updatePreview();
				}
			}

			formatCode() {
				try {
					const language = this.languageSelect.value;
					let formatted = this.codeEditor.value;

					if (language === 'json') {
						formatted = JSON.stringify(JSON.parse(formatted), null, 2);
					} else if (language === 'html') {
						// Basic HTML formatting
						formatted = formatted.replace(/></g, '>\n<');
					}

					this.addToUndoStack();
					this.codeEditor.value = formatted;
					this.updateLineNumbers();
					this.updateFileSize();
					this.markAsChanged();
				} catch (error) {
					alert('Failed to format code: ' + error.message);
				}
			}

			toggleWordWrap() {
				const isWrapped = this.codeEditor.style.whiteSpace === 'pre-wrap';
				this.codeEditor.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
				this.wrapBtn.classList.toggle('active', !isWrapped);
			}

			async saveChanges() {
				if (!this.currentFile || !this.hasUnsavedChanges) return;

				const description = this.changeDescription.value.trim() || 'File updated via editor';

				try {
					this.saveChangesBtn.disabled = true;
					this.saveChangesBtn.innerHTML = `
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
							<path d="M3 3v5h5"/>
						</svg>
						Saving...
					`;

					// Save content if changed
					const contentChanged = this.codeEditor.value !== this.originalContent;
					if (contentChanged) {
						const contentResponse = await fetch(`/api/file-editor/${this.currentFile.id}/content`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json',
								...cdnApp.auth.getAuthHeader()
							},
							body: JSON.stringify({
								content: this.codeEditor.value,
								description: description
							})
						});

						if (!contentResponse.ok) {
							throw new Error('Failed to save content');
						}
					}

					// Save metadata if changed
					const metadataChanged = this.hasMetadataChanged();
					if (metadataChanged) {
						const customFieldsObj = {};
						this.customFields.forEach(field => {
							if (field.key && field.value) {
								customFieldsObj[field.key] = field.value;
							}
						});

						const metadataResponse = await fetch(`/api/file-editor/${this.currentFile.id}/metadata`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json',
								...cdnApp.auth.getAuthHeader()
							},
							body: JSON.stringify({
								name: this.metaFileName.value,
								description: this.metaDescription.value,
								category: this.metaCategory.value,
								tags: this.tags,
								customFields: customFieldsObj,
								changeDescription: description
							})
						});

						if (!metadataResponse.ok) {
							throw new Error('Failed to save metadata');
						}
					}

					// Update original values
					this.originalContent = this.codeEditor.value;
					this.originalMetadata = {
						name: this.metaFileName.value,
						description: this.metaDescription.value,
						category: this.metaCategory.value,
						tags: [...this.tags],
						customFields: {...this.getCustomFieldsObject()}
					};

					this.resetChangeTracking();
					this.changeDescription.value = '';
					alert('Changes saved successfully!');

				} catch (error) {
					console.error('Save error:', error);
					alert('Failed to save changes: ' + error.message);
				} finally {
					this.saveChangesBtn.disabled = false;
					this.saveChangesBtn.innerHTML = `
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
							<polyline points="17,21 17,13 7,13 7,21"/>
							<polyline points="7,3 7,8 15,8"/>
						</svg>
						Save Changes
					`;
				}
			}

			hasMetadataChanged() {
				return (
					this.metaFileName.value !== this.originalMetadata.name ||
					this.metaDescription.value !== this.originalMetadata.description ||
					this.metaCategory.value !== this.originalMetadata.category ||
					JSON.stringify(this.tags) !== JSON.stringify(this.originalMetadata.tags) ||
					JSON.stringify(this.getCustomFieldsObject()) !== JSON.stringify(this.originalMetadata.customFields)
				);
			}

			getCustomFieldsObject() {
				const obj = {};
				this.customFields.forEach(field => {
					if (field.key && field.value) {
						obj[field.key] = field.value;
					}
				});
				return obj;
			}

			discardChanges() {
				if (!confirm('Are you sure you want to discard all changes?')) return;

				this.populateEditor();
				this.resetChangeTracking();
				this.changeDescription.value = '';
			}

			async viewVersionHistory() {
				if (!this.currentFile) return;

				try {
					const response = await fetch(`/api/versions/${this.currentFile.id}`, {
						headers: cdnApp.auth.getAuthHeader()
					});

					if (!response.ok) {
						throw new Error('Failed to load version history');
					}

					const result = await response.json();
					this.showVersionHistoryModal(result.versions);

				} catch (error) {
					console.error('Version history error:', error);
					alert('Failed to load version history: ' + error.message);
				}
			}

			showVersionHistoryModal(versions) {
				const modal = document.createElement('div');
				modal.className = 'version-history-modal';
				modal.innerHTML = `
					<div class="modal-backdrop"></div>
					<div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
						<div class="modal-header">
							<h3>Version History - ${this.currentFile.name}</h3>
							<button class="modal-close" onclick="this.closest('.version-history-modal').remove()">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<line x1="18" y1="6" x2="6" y2="18"/>
									<line x1="6" y1="6" x2="18" y2="18"/>
								</svg>
							</button>
						</div>
						<div class="modal-body">
							<div class="version-list">
								${versions.map((version, index) => `
									<div class="version-item">
										<div class="version-header">
											<div class="version-info">
												<strong>Version ${version.version}</strong>
												<span class="version-date">${new Date(version.timestamp).toLocaleString()}</span>
											</div>
											<div class="version-actions">
												<button class="btn btn-secondary btn-sm" onclick="window.cdnApp.fileEditor.restoreVersion('${version.id}')">
													Restore
												</button>
											</div>
										</div>
										<div class="version-details">
											<div><strong>Author:</strong> ${version.author}</div>
											<div><strong>Changes:</strong> ${version.changeType}</div>
											${version.description ? `<div><strong>Description:</strong> ${version.description}</div>` : ''}
										</div>
									</div>
								`).join('')}
							</div>
						</div>
					</div>
				`;

				document.body.appendChild(modal);
				modal.classList.add('show');

				// Close on backdrop click
				modal.querySelector('.modal-backdrop').addEventListener('click', () => {
					modal.remove();
				});
			}

			async restoreVersion(versionId) {
				if (!confirm('Are you sure you want to restore this version? This will overwrite the current content.')) {
					return;
				}

				try {
					const response = await fetch(`/api/versions/${this.currentFile.id}/restore`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							...cdnApp.auth.getAuthHeader()
						},
						body: JSON.stringify({ versionId })
					});

					if (!response.ok) {
						throw new Error('Failed to restore version');
					}

					// Close version history modal
					document.querySelector('.version-history-modal')?.remove();

					// Reload the file
					await this.selectFile(this.currentFile.id);
					alert('Version restored successfully!');

				} catch (error) {
					console.error('Restore version error:', error);
					alert('Failed to restore version: ' + error.message);
				}
			}

			downloadFile() {
				if (!this.currentFile) return;
				window.open(this.currentFile.path, '_blank');
			}

			handleKeyboardShortcuts(e) {
				if (!this.modal.classList.contains('show')) return;

				if (e.ctrlKey || e.metaKey) {
					switch (e.key) {
						case 's':
							e.preventDefault();
							this.saveChanges();
							break;
						case 'z':
							if (e.shiftKey) {
								e.preventDefault();
								this.redo();
							} else {
								e.preventDefault();
								this.undo();
							}
							break;
						case 'y':
							e.preventDefault();
							this.redo();
							break;
						case 'f':
							if (e.shiftKey) {
								e.preventDefault();
								this.formatCode();
							}
							break;
					}
				}
			}

			resetEditor() {
				this.currentFile = null;
				this.originalContent = null;
				this.originalMetadata = null;
				this.hasUnsavedChanges = false;
				this.tags = [];
				this.customFields = [];
				this.codeEditor.value = '';
				this.changeDescription.value = '';
				this.currentFileSection.style.display = 'none';
				this.saveActionsSection.style.display = 'none';
				this.resetChangeTracking();
			}

			formatFileSize(bytes) {
				if (bytes === 0) return '0 Bytes';
				const k = 1024;
				const sizes = ['Bytes', 'KB', 'MB', 'GB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
			}

			escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}
		}

		// Create CDN Application object
		window.cdnApp = {
			auth: null,
			statusModal: null,
			apiModal: null,
			devToolsModal: null,
			assetSearch: null,
			fileEditor: null
		};

		// Initialize authenticated search when DOM is loaded
		document.addEventListener('DOMContentLoaded', () => {
			// Initialize authentication first
			cdnApp.auth = new SXAPAuth();

			// Initialize asset search with authentication
			cdnApp.assetSearch = new AuthenticatedAssetSearch();

			// Initialize modals
			cdnApp.statusModal = new StatusModal();
			cdnApp.apiModal = new APIModal();
			cdnApp.devToolsModal = new DevToolsModal();
			cdnApp.fileEditor = new FileEditorModal();

			// Setup footer link event listeners
			document.getElementById('statusLink').addEventListener('click', (e) => {
				e.preventDefault();
				cdnApp.statusModal.show();
			});

			document.getElementById('apiLink').addEventListener('click', (e) => {
				e.preventDefault();
				cdnApp.apiModal.show();
			});

			document.getElementById('devToolsLink').addEventListener('click', (e) => {
				e.preventDefault();
				cdnApp.devToolsModal.show();
			});

			// Add file editor button to the main interface
			const uploadBtn = document.querySelector('.upload-btn');
			if (uploadBtn) {
				const editorBtn = document.createElement('button');
				editorBtn.className = 'document-btn';
				editorBtn.title = 'File Editor';
				editorBtn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
						<polyline points="14,2 14,8 20,8" />
					</svg>
				`;
				editorBtn.addEventListener('click', (e) => {
					e.preventDefault();
					cdnApp.fileEditor.show();
				});
				uploadBtn.parentNode.insertBefore(editorBtn, uploadBtn.nextSibling);
			}
		});

		// Loading Animation System
		class LoadingManager {
			constructor() {
				this.overlay = null;
				this.bar = null;
				this.pulse = null;
				this.isLoading = false;
				this.loadingQueue = new Set();
				this.activeOperations = new Map();
				this.init();
			}

			init() {
				// Create loading elements
				this.createElements();

				// Bind to existing heavy operations
				this.bindToExistingOperations();

				// Setup event listeners for dynamic operations
				this.setupEventListeners();
			}

			createElements() {
				// Create overlay
				this.overlay = document.createElement('div');
				this.overlay.className = 'loading-overlay';
				document.body.appendChild(this.overlay);

				// Create progress bar
				this.bar = document.createElement('div');
				this.bar.className = 'loading-bar';
				document.body.appendChild(this.bar);

				// Create pulse effect
				this.pulse = document.createElement('div');
				this.pulse.className = 'loading-pulse';
				document.body.appendChild(this.pulse);
			}

			start(operationId = 'default', options = {}) {
				const operation = {
					id: operationId,
					startTime: Date.now(),
					options: {
						showOverlay: true,
						dimContent: true,
						...options
					}
				};

				this.activeOperations.set(operationId, operation);
				this.loadingQueue.add(operationId);

				if (!this.isLoading) {
					this.show();
				}

				return operationId;
			}

			stop(operationId = 'default') {
				this.activeOperations.delete(operationId);
				this.loadingQueue.delete(operationId);

				if (this.loadingQueue.size === 0) {
					this.hide();
				}
			}

			show() {
				this.isLoading = true;

				// Show overlay with subtle backdrop
				if (this.overlay) {
					this.overlay.classList.add('active');
				}

				// Show progress bar
				if (this.bar) {
					this.bar.classList.add('active');
				}

				// Show pulse effect
				if (this.pulse) {
					this.pulse.classList.add('active');
				}

				// Dim content
				const mainContent = document.querySelector('.container');
				if (mainContent) {
					mainContent.classList.add('content-loading', 'dimmed');
				}

				// Add breathing effect to main elements
				const header = document.querySelector('.header');
				if (header) {
					header.classList.add('loading-breathe');
				}
			}

			hide() {
				// Complete the progress bar animation
				if (this.bar) {
					this.bar.classList.remove('active');
					this.bar.classList.add('complete');
				}

				// Wait for completion animation then hide everything
				setTimeout(() => {
					this.isLoading = false;

					// Hide overlay
					if (this.overlay) {
						this.overlay.classList.remove('active');
					}

					// Reset progress bar
					if (this.bar) {
						this.bar.classList.remove('complete');
					}

					// Hide pulse
					if (this.pulse) {
						this.pulse.classList.remove('active');
					}

					// Restore content
					const mainContent = document.querySelector('.container');
					if (mainContent) {
						mainContent.classList.remove('content-loading', 'dimmed');
					}

					// Remove breathing effect
					const header = document.querySelector('.header');
					if (header) {
						header.classList.remove('loading-breathe');
					}
				}, 300);
			}

			bindToExistingOperations() {
				// Bind to asset search operations
				const originalSearch = window.cdnApp?.assetSearch?.performSearch;
				if (originalSearch) {
					window.cdnApp.assetSearch.performSearch = async function(...args) {
						const loadingId = window.cdnApp.loading.start('asset-search');
						try {
							const result = await originalSearch.apply(this, args);
							return result;
						} finally {
							window.cdnApp.loading.stop(loadingId);
						}
					};
				}

				// Bind to file operations
				this.bindToFileOperations();

				// Bind to API calls
				this.bindToApiCalls();
			}

			bindToFileOperations() {
				if (window.cdnApp?.fileEditor) {
					const originalSave = window.cdnApp.fileEditor.saveChanges;
					if (originalSave) {
						window.cdnApp.fileEditor.saveChanges = async function(...args) {
							const loadingId = window.cdnApp.loading.start('file-save');
							try {
								const result = await originalSave.apply(this, args);
								return result;
							} finally {
								window.cdnApp.loading.stop(loadingId);
							}
						};
					}
				}
			}

			bindToApiCalls() {
				// Intercept fetch requests for heavy operations
				const originalFetch = window.fetch;
				window.fetch = async function(url, options = {}) {
					// Only show loading for certain endpoints
					const heavyEndpoints = ['/api/', '/upload', '/process', '/convert'];
					const isHeavyOperation = heavyEndpoints.some(endpoint =>
						typeof url === 'string' && url.includes(endpoint)
					);

					if (isHeavyOperation && !options.skipLoading) {
						const loadingId = window.cdnApp.loading.start('api-call');
						try {
							const result = await originalFetch(url, options);
							return result;
						} finally {
							window.cdnApp.loading.stop(loadingId);
						}
					}

					return originalFetch(url, options);
				};
			}

			setupEventListeners() {
				// Listen for custom loading events
				document.addEventListener('loading:start', (e) => {
					this.start(e.detail?.id || 'custom', e.detail?.options);
				});

				document.addEventListener('loading:stop', (e) => {
					this.stop(e.detail?.id || 'custom');
				});

				// Listen for page visibility changes
				document.addEventListener('visibilitychange', () => {
					if (document.hidden && this.isLoading) {
						// Pause animations when page is hidden for performance
						this.bar?.style.setProperty('animation-play-state', 'paused');
						this.pulse?.style.setProperty('animation-play-state', 'paused');
					} else if (!document.hidden && this.isLoading) {
						// Resume animations when page is visible
						this.bar?.style.setProperty('animation-play-state', 'running');
						this.pulse?.style.setProperty('animation-play-state', 'running');
					}
				});
			}

			// Utility methods for manual control
			async withLoading(operation, operationId = 'manual', options = {}) {
				const id = this.start(operationId, options);
				try {
					const result = await operation();
					return result;
				} finally {
					this.stop(id);
				}
			}

			// Simulate heavy operation (for demo purposes)
			simulateHeavyOperation(duration = 3000) {
				return new Promise(resolve => {
					const id = this.start('demo-operation');
					setTimeout(() => {
						this.stop(id);
						resolve();
					}, duration);
				});
			}
		}

		// Professional Search Mode Manager
		class ProfessionalSearchMode {
			constructor() {
				this.isActive = false;
				this.originalSearchInput = document.getElementById('searchInput');
				this.searchModeContainer = document.getElementById('searchModeContainer');
				this.searchModeInput = document.getElementById('searchModeInput');
				this.searchModeClose = document.getElementById('searchModeClose');
				this.searchModeClear = document.getElementById('searchModeClear');
				this.searchModeGrid = document.getElementById('searchModeGrid');
				this.searchModeStats = document.getElementById('searchModeStats');
				this.searchModeStatsText = document.getElementById('searchModeStatsText');
				this.searchModeLoading = document.getElementById('searchModeLoading');
				this.searchModeEmpty = document.getElementById('searchModeEmpty');
				this.searchModeFilters = document.getElementById('searchModeFilters');

				this.currentFilter = 'all';
				this.searchCache = new Map();
				this.debounceTimer = null;

				this.init();
			}

			init() {

				// Listen for input in original search to trigger transformation
				this.originalSearchInput.addEventListener('input', (e) => {
					if (e.target.value.trim() && !this.isActive) {
						this.enterSearchMode(e.target.value);
					}
				});

				// Professional search mode controls
				this.searchModeClose.addEventListener('click', () => {
					this.exitSearchMode();
				});

				this.searchModeClear.addEventListener('click', () => {
					this.clearSearch();
				});

				// Search input handling
				this.searchModeInput.addEventListener('input', (e) => {
					this.handleSearchInput(e.target.value);
				});

				this.searchModeInput.addEventListener('keydown', (e) => {
					if (e.key === 'Enter') {
						e.preventDefault();
						this.performSearch(e.target.value, true);
					}
					if (e.key === 'Escape') {
						this.exitSearchMode();
					}
				});

				// Filter handling
				this.searchModeFilters.addEventListener('click', (e) => {
					if (e.target.classList.contains('search-mode-filter')) {
						this.handleFilterChange(e.target.dataset.filter);
					}
				});

				// Keyboard shortcuts
				document.addEventListener('keydown', (e) => {
					if (this.isActive && e.key === 'Escape') {
						this.exitSearchMode();
					}
				});
			}

			enterSearchMode(initialQuery = '') {
				this.isActive = true;
				
				this.searchModeContainer.style.display = 'block';
				
				// Transfer query if provided
				if (initialQuery) {
					this.searchModeInput.value = initialQuery;
					this.updateClearButton();
					this.performSearch(initialQuery);
				}
				
				// Focus the professional search input
				setTimeout(() => {
					this.searchModeInput.focus();
				}, 100);

				// Clear original search input
				this.originalSearchInput.value = '';
			}

			exitSearchMode() {
				this.isActive = false;
				
				
				// Hide the search mode container
				setTimeout(() => {
					this.searchModeContainer.style.display = 'none';
				}, 300);

				// Clear search results
				this.clearResults();
				
				// Focus original search input
				setTimeout(() => {
					this.originalSearchInput.focus();
				}, 400);
			}

			handleSearchInput(query) {
				clearTimeout(this.debounceTimer);
				this.updateClearButton();

				if (!query.trim()) {
					this.hideStats();
					this.clearResults();
					return;
				}

				this.debounceTimer = setTimeout(() => {
					this.performSearch(query.trim());
				}, 300);
			}

			async performSearch(query, immediate = false) {
				if (!query.trim()) return;

				const cacheKey = `${query}-${this.currentFilter}`;
				
				if (this.searchCache.has(cacheKey)) {
					this.displayResults(this.searchCache.get(cacheKey), query);
					return;
				}

				this.showLoading();

				try {
					const startTime = Date.now();
					const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=24`);
					const data = await response.json();
					const searchTime = Date.now() - startTime;

					if (response.ok) {
						const results = data.results || [];
						this.searchCache.set(cacheKey, { results, searchTime });
						this.displayResults({ results, searchTime }, query);
					} else {
						this.displayError(data.error || 'Search failed');
					}
				} catch (error) {
					console.error('Professional search error:', error);
					this.displayError('Network error occurred');
				} finally {
					this.hideLoading();
				}
			}

			displayResults(data, query) {
				const { results, searchTime } = data;
				
				this.updateStats(results.length, searchTime);
				this.searchModeGrid.innerHTML = '';

				if (results.length === 0) {
					this.showEmpty();
					return;
				}

				this.hideEmpty();
				
				results.forEach((result, index) => {
					const card = this.createProfessionalCard(result, index);
					this.searchModeGrid.appendChild(card);
				});
			}

			createProfessionalCard(result, index) {
				const card = document.createElement('div');
				card.className = 'search-mode-card';
				card.style.animationDelay = `${index * 50}ms`;

				const icon = this.getProfessionalIcon(result.type);
				const tags = this.generateTags(result);
				const fileSize = result.size ? this.formatFileSize(result.size) : '';
				const modified = result.lastModified ? this.formatDate(result.lastModified) : '';

				card.innerHTML = `
					<div class="search-mode-card-header">
						<div class="search-mode-card-icon">
							${icon}
						</div>
						<div class="search-mode-card-content">
							<h3 class="search-mode-card-title">${this.escapeHtml(result.name)}</h3>
							<div class="search-mode-card-url">${window.location.origin}${this.escapeHtml(result.path)}</div>
						</div>
					</div>
					<div class="search-mode-card-description">
						${this.generateDescription(result)}
					</div>
					<div class="search-mode-card-meta">
						<div class="search-mode-card-tags">
							${tags.map(tag => `<span class="search-mode-card-tag">${tag}</span>`).join('')}
						</div>
						<div class="search-mode-card-info">
							${[fileSize, modified].filter(Boolean).join(' • ')}
						</div>
					</div>
				`;

				card.addEventListener('click', () => {
					this.openAsset(result.path);
				});

				return card;
			}

			getProfessionalIcon(type) {
				const icons = {
					image: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>',
					font: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,7 4,4 20,4 20,7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',
					css: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 22,8.5 22,15.5 12,22 2,15.5 2,8.5"/><line x1="12" y1="22" x2="12" y2="15.5"/><polyline points="22,8.5 12,15.5 2,8.5"/></svg>',
					js: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>',
					video: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23,7 16,12 23,17"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>',
					audio: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11,5 6,9 2,9 2,15 6,15 11,19"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>',
					document: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2Z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>',
				};
				return icons[type] || icons.document;
			}

			generateTags(result) {
				const tags = [result.type];
				if (result.category) tags.push(result.category);
				if (result.size && result.size > 1024 * 1024) tags.push('Large');
				return tags;
			}

			generateDescription(result) {
				const descriptions = {
					image: 'High-quality image asset ready for web and print use',
					font: 'Professional font file for typography and design projects',
					css: 'Stylesheet for modern web design and styling',
					js: 'JavaScript file for interactive web functionality',
					video: 'Video content for multimedia projects',
					audio: 'Audio file for media and sound design',
					document: 'Document file for content and documentation'
				};
				return descriptions[result.type] || 'Professional asset for your projects';
			}

			handleFilterChange(filter) {
				this.currentFilter = filter;
				
				// Update filter UI
				this.searchModeFilters.querySelectorAll('.search-mode-filter').forEach(btn => {
					btn.classList.toggle('active', btn.dataset.filter === filter);
				});

				// Re-perform search with new filter
				const query = this.searchModeInput.value.trim();
				if (query) {
					this.performSearch(query);
				}
			}

			updateStats(count, searchTime) {
				const timeInSeconds = (searchTime / 1000).toFixed(2);
				this.searchModeStatsText.textContent = `About ${count} results (${timeInSeconds} seconds)`;
				this.searchModeStats.style.display = 'flex';
			}

			hideStats() {
				this.searchModeStats.style.display = 'none';
			}

			showLoading() {
				this.searchModeLoading.style.display = 'flex';
				this.searchModeGrid.style.display = 'none';
				this.hideEmpty();
			}

			hideLoading() {
				this.searchModeLoading.style.display = 'none';
				this.searchModeGrid.style.display = 'grid';
			}

			showEmpty() {
				this.searchModeEmpty.style.display = 'block';
				this.searchModeGrid.style.display = 'none';
			}

			hideEmpty() {
				this.searchModeEmpty.style.display = 'none';
			}

			clearResults() {
				this.searchModeGrid.innerHTML = '';
				this.hideStats();
				this.hideEmpty();
			}

			clearSearch() {
				this.searchModeInput.value = '';
				this.updateClearButton();
				this.clearResults();
				this.searchModeInput.focus();
			}

			updateClearButton() {
				const hasValue = this.searchModeInput.value.trim().length > 0;
				this.searchModeClear.classList.toggle('visible', hasValue);
			}

			displayError(message) {
				this.searchModeGrid.innerHTML = `
					<div class="search-mode-empty">
						<svg class="search-mode-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<circle cx="12" cy="12" r="10"/>
							<line x1="12" y1="8" x2="12" y2="12"/>
							<line x1="12" y1="16" x2="12.01" y2="16"/>
						</svg>
						<h3 class="search-mode-empty-title">Search Error</h3>
						<p class="search-mode-empty-description">${this.escapeHtml(message)}</p>
					</div>
				`;
			}

			openAsset(path) {
				window.open(path, '_blank');
			}

			formatFileSize(bytes) {
				if (bytes === 0) return '0 B';
				const k = 1024;
				const sizes = ['B', 'KB', 'MB', 'GB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
			}

			formatDate(timestamp) {
				const date = new Date(timestamp);
				const now = new Date();
				const diff = now - date;
				const days = Math.floor(diff / (1000 * 60 * 60 * 24));

				if (days === 0) return 'Today';
				if (days === 1) return 'Yesterday';
				if (days < 7) return `${days}d ago`;
				return date.toLocaleDateString();
			}

			escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}
		}

		// Initialize loading manager after DOM is ready
		document.addEventListener('DOMContentLoaded', () => {
			// Wait for other systems to initialize first
			setTimeout(() => {
				window.cdnApp.loading = new LoadingManager();
				window.cdnApp.professionalSearch = new ProfessionalSearchMode();

				// Add demo button for testing (remove in production)
				if (window.location.search.includes('debug=1')) {
					const demoBtn = document.createElement('button');
					demoBtn.textContent = 'Test Loading';
					demoBtn.className = 'btn btn-secondary';
					demoBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
					demoBtn.onclick = () => window.cdnApp.loading.simulateHeavyOperation();
					document.body.appendChild(demoBtn);
				}
			}, 100);
		});
		</script>
	</body>
</html>
